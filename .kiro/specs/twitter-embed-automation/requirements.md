# 要件定義書

## はじめに

本ドキュメントは、「しのうたタイム」アプリケーションにおけるTwitter埋め込みコード取得の自動化機能に関する要件を定義します。現在、Twitter（X）の埋め込みコードは手動で取得し、`data/tweet_embed_code.html`ファイルに保存していますが、この作業を自動化することで、運用効率を向上させることを目的とします。

## 用語集

- **システム**: Twitter埋め込みコード自動取得システム
- **Twitter API**: Twitter（X）が提供するAPI（Application Programming Interface）
- **埋め込みコード**: TwitterのツイートをWebページに表示するためのHTMLコード
- **ツイートURL**: Twitter上の特定のツイートを指すURL（例: https://twitter.com/username/status/1234567890）
- **データファイル**: `data/tweet_embed_code.html`および`data/tweet_height.txt`
- **管理者**: アプリケーションのデータを管理する運用担当者
- **情報ページ**: アプリケーション内の「Information」ページ（`pages/01_Information.py`）

## 要件

### 要件1

**ユーザーストーリー:** 管理者として、ツイートURLを指定するだけで埋め込みコードを自動取得したい。そうすることで、手動でTwitterサイトから埋め込みコードをコピーする手間を省きたい。

#### 受入基準

1. WHEN 管理者がツイートURLを入力する THEN システムはそのURLからツイートIDを抽出する
2. WHEN システムがツイートIDを取得する THEN システムはTwitter oEmbed APIを使用して埋め込みコードを取得する
3. WHEN 埋め込みコードの取得に成功する THEN システムは取得したHTMLコードを`data/tweet_embed_code.html`に保存する
4. WHEN 埋め込みコードの取得に失敗する THEN システムは適切なエラーメッセージを表示し、既存のファイルを変更しない
5. WHEN 無効なツイートURLが入力される THEN システムはURL形式の検証を行い、エラーメッセージを表示する

### 要件2

**ユーザーストーリー:** 管理者として、複数のツイートを一度に指定して埋め込みコードを取得したい。そうすることで、複数のお知らせを効率的に情報ページに表示できる。

#### 受入基準

1. WHEN 管理者が複数のツイートURLをリスト形式で入力する THEN システムは各URLを順次処理する
2. WHEN 複数のツイートの埋め込みコードを取得する THEN システムは全ての埋め込みコードを連結して1つのHTMLファイルに保存する
3. WHEN 複数のツイート取得中に一部が失敗する THEN システムは成功したツイートのみを保存し、失敗したツイートのリストを表示する
4. WHEN 複数のツイートを処理する THEN システムはAPI制限を考慮して適切な間隔で処理を実行する

### 要件3

**ユーザーストーリー:** 管理者として、埋め込みコードの取得をコマンドラインから実行したい。そうすることで、スクリプトやバッチ処理に組み込むことができる。

#### 受入基準

1. WHEN 管理者がコマンドラインからスクリプトを実行する THEN システムはコマンドライン引数としてツイートURLを受け取る
2. WHEN コマンドライン引数が不足している THEN システムは使用方法を表示し、エラーコードを返す
3. WHEN コマンドラインから実行される THEN システムは処理の進行状況をコンソールに出力する
4. WHEN 処理が成功する THEN システムは成功メッセージを表示し、終了コード0を返す
5. WHEN 処理が失敗する THEN システムはエラーメッセージを表示し、非ゼロの終了コードを返す

### 要件4

**ユーザーストーリー:** 管理者として、埋め込みコードの取得をStreamlitアプリケーション内から実行したい。そうすることで、アプリケーションを使用しながら簡単に更新作業ができる。

#### 受入基準

1. WHEN 管理者がStreamlitアプリケーションの管理画面にアクセスする THEN システムはツイートURL入力フォームを表示する
2. WHEN 管理者がフォームにツイートURLを入力して送信する THEN システムは埋め込みコードを取得し、結果を画面に表示する
3. WHEN 取得が成功する THEN システムは取得した埋め込みコードのプレビューを表示する
4. WHEN 取得が失敗する THEN システムはエラーメッセージを画面に表示する
5. WHILE 管理画面を使用している THEN システムは認証や権限チェックを実施し、不正なアクセスを防止する

### 要件5

**ユーザーストーリー:** 開発者として、Twitter API認証情報を安全に管理したい。そうすることで、セキュリティリスクを最小限に抑えることができる。

#### 受入基準

1. WHEN システムがTwitter APIにアクセスする THEN システムは環境変数から認証情報を読み込む
2. WHEN 認証情報が環境変数に設定されていない THEN システムは適切なエラーメッセージを表示し、処理を中断する
3. WHEN 認証情報をファイルに保存する THEN システムは`.env`ファイルを使用し、`.gitignore`に含める
4. THE システムは認証情報をログやエラーメッセージに出力しない
5. THE システムは認証情報をハードコーディングしない

### 要件6

**ユーザーストーリー:** 管理者として、取得した埋め込みコードが正しく動作することを確認したい。そうすることで、情報ページに表示する前に問題を発見できる。

#### 受入基準

1. WHEN 埋め込みコードを取得する THEN システムは取得したHTMLコードの基本的な検証を実行する
2. WHEN HTMLコードが不正な形式である THEN システムは警告メッセージを表示する
3. WHEN 埋め込みコードを保存する THEN システムは既存のファイルのバックアップを作成する
4. WHEN バックアップの作成に失敗する THEN システムは警告を表示するが、処理は継続する

### 要件7

**ユーザーストーリー:** 管理者として、埋め込みコードの取得履歴を確認したい。そうすることで、いつどのツイートを追加したかを追跡できる。

#### 受入基準

1. WHEN 埋め込みコードを取得する THEN システムは取得日時、ツイートURL、成功/失敗をログファイルに記録する
2. WHEN ログファイルが存在しない THEN システムは新しいログファイルを作成する
3. WHEN ログファイルが一定サイズを超える THEN システムはログローテーションを実行する
4. THE システムはログファイルを`logs/twitter_embed.log`に保存する

### 要件8

**ユーザーストーリー:** 開発者として、Twitter APIの代替手段を使用できるようにしたい。そうすることで、API制限や障害時にも機能を維持できる。

#### 受入基準

1. WHEN Twitter oEmbed APIが利用できない THEN システムは代替手段（スクレイピングなど）を試行する
2. WHEN 代替手段を使用する THEN システムは使用した方法をログに記録する
3. WHEN 全ての取得方法が失敗する THEN システムは詳細なエラーメッセージを表示する
4. THE システムは設定ファイルで取得方法の優先順位を指定できる

### 要件9

**ユーザーストーリー:** 管理者として、埋め込みコードの表示高さを自動的に設定したい。そうすることで、`data/tweet_height.txt`を手動で編集する必要がなくなる。

#### 受入基準

1. WHEN 埋め込みコードを取得する THEN システムはツイートの推奨表示高さを取得する
2. WHEN 表示高さ情報が利用可能である THEN システムは`data/tweet_height.txt`に高さを保存する
3. WHEN 表示高さ情報が利用できない THEN システムはデフォルト値（850ピクセル）を使用する
4. WHEN 複数のツイートを取得する THEN システムは最大の高さ値を使用する

### 要件10

**ユーザーストーリー:** 開発者として、システムが適切なエラーハンドリングを実装していることを確認したい。そうすることで、予期しないエラーでアプリケーションが停止することを防げる。

#### 受入基準

1. WHEN ネットワークエラーが発生する THEN システムは適切なエラーメッセージを表示し、リトライ機能を提供する
2. WHEN API制限に達する THEN システムは制限解除までの待機時間を表示する
3. WHEN ファイル書き込みエラーが発生する THEN システムはファイルシステムのエラーを適切に処理する
4. WHEN 予期しないエラーが発生する THEN システムは詳細なエラー情報をログに記録し、ユーザーには分かりやすいメッセージを表示する
5. THE システムは全てのエラーを適切にログに記録する
