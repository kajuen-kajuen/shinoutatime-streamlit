# 要件定義書

## はじめに

本ドキュメントは、V_SONG_LIST.TSVのアーティスト名（ソート用）が誤っている場合に修正できる仕組みの要件を定義します。

現在、アーティスト名（ソート用）は`ArtistSortGenerator`クラスによって自動的にひらがなに変換されていますが、以下のような問題があります：

- 自動変換が誤った読み仮名を生成する場合がある
- 特殊な読み方をするアーティスト名に対応できない
- 一度生成されたソート名を手動で修正する手段がない

本機能により、ユーザーが誤ったソート名を手動で修正し、その修正を永続化できるようにします。

## 用語集

- **V_SONG_LIST.TSV**: 曲リストを格納するTSVファイル。アーティスト名、アーティスト名（ソート用）、曲名、最近の歌唱URLを含む
- **ArtistSortGenerator**: アーティスト名から自動的にソート用の読み仮名を生成するクラス
- **修正マッピングファイル**: アーティスト名とその正しいソート名の対応関係を保存するファイル
- **SongListService**: 曲リストを生成するサービスクラス

## 要件

### 要件 1: 修正マッピングの保存

**ユーザーストーリー:** 開発者として、誤ったアーティスト名（ソート用）を修正し、その修正を永続化したい。そうすることで、次回の曲リスト生成時にも修正が反映される。

#### 受入基準

1. WHEN 修正マッピングファイルが指定されたパスに存在する THEN システムはそのファイルを読み込む
2. WHEN 修正マッピングファイルが存在しない THEN システムは空のマッピングとして処理を続行する
3. WHEN 修正マッピングファイルの形式が不正である THEN システムはエラーメッセージを出力し、処理を中断する
4. WHEN 新しい修正マッピングが追加される THEN システムは修正マッピングファイルに追記する
5. WHEN 既存の修正マッピングが更新される THEN システムは修正マッピングファイル内の該当エントリを更新する

### 要件 2: 修正マッピングの適用

**ユーザーストーリー:** システムとして、曲リスト生成時に修正マッピングを適用したい。そうすることで、自動生成されたソート名よりも修正マッピングを優先できる。

#### 受入基準

1. WHEN アーティスト名に対する修正マッピングが存在する THEN システムは自動生成されたソート名の代わりに修正マッピングのソート名を使用する
2. WHEN アーティスト名に対する修正マッピングが存在しない THEN システムは自動生成されたソート名を使用する
3. WHEN 曲リストが生成される THEN システムはすべてのアーティスト名に対して修正マッピングの適用を試みる
4. WHEN 修正マッピングが適用される THEN システムはログに適用されたマッピングの情報を出力する

### 要件 3: 修正マッピングの管理インターフェース

**ユーザーストーリー:** 開発者として、コマンドラインから修正マッピングを追加・更新・削除したい。そうすることで、ファイルを直接編集せずに修正を管理できる。

#### 受入基準

1. WHEN ユーザーが修正マッピング追加コマンドを実行する THEN システムはアーティスト名と正しいソート名を受け取り、修正マッピングファイルに保存する
2. WHEN ユーザーが修正マッピング一覧表示コマンドを実行する THEN システムは現在の修正マッピングをすべて表示する
3. WHEN ユーザーが修正マッピング削除コマンドを実行する THEN システムは指定されたアーティスト名の修正マッピングを削除する
4. WHEN ユーザーが存在しないアーティスト名の修正マッピングを削除しようとする THEN システムはエラーメッセージを表示する
5. WHEN ユーザーが修正マッピング更新コマンドを実行する THEN システムは既存の修正マッピングを新しい値で上書きする

### 要件 4: 修正マッピングファイルの形式

**ユーザーストーリー:** システムとして、修正マッピングを人間が読みやすく、かつ機械的に処理しやすい形式で保存したい。そうすることで、手動編集も可能にしつつ、プログラムからの操作も容易にする。

#### 受入基準

1. WHEN 修正マッピングファイルが作成される THEN システムはTSV形式でファイルを作成する
2. WHEN 修正マッピングファイルが作成される THEN システムはヘッダー行として「アーティスト名」と「ソート名」を含める
3. WHEN 修正マッピングファイルが読み込まれる THEN システムはUTF-8エンコーディングでファイルを読み込む
4. WHEN 修正マッピングファイルに重複したアーティスト名が存在する THEN システムは最後のエントリを有効とする
5. WHEN 修正マッピングファイルに空行が含まれる THEN システムは空行を無視する

### 要件 5: 既存システムとの統合

**ユーザーストーリー:** システムとして、既存の曲リスト生成フローに修正マッピング機能をシームレスに統合したい。そうすることで、既存の機能を壊さずに新機能を追加できる。

#### 受入基準

1. WHEN SongListServiceが初期化される THEN システムは修正マッピングファイルのパスを受け取る
2. WHEN 修正マッピングファイルのパスが指定されない THEN システムはデフォルトパスを使用する
3. WHEN ArtistSortGeneratorがソート名を生成する THEN システムは修正マッピングを優先的に適用する
4. WHEN 曲リストが生成される THEN システムは修正マッピングの適用状況をログに記録する
5. WHEN 既存のテストが実行される THEN システムはすべてのテストが引き続き成功する

### 要件 6: エラーハンドリング

**ユーザーストーリー:** システムとして、修正マッピング機能で発生する可能性のあるエラーを適切に処理したい。そうすることで、システムの安定性を保つ。

#### 受入基準

1. WHEN 修正マッピングファイルの読み込みに失敗する THEN システムはエラーメッセージをログに出力し、空のマッピングとして処理を続行する
2. WHEN 修正マッピングファイルへの書き込みに失敗する THEN システムはエラーメッセージを表示し、処理を中断する
3. WHEN 不正な形式の修正マッピングエントリが検出される THEN システムは警告メッセージをログに出力し、そのエントリをスキップする
4. WHEN ファイルシステムのアクセス権限エラーが発生する THEN システムは適切なエラーメッセージを表示する
