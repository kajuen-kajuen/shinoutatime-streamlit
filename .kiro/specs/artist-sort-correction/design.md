# 設計書

## 概要

本設計書は、V_SONG_LIST.TSVのアーティスト名（ソート用）を修正できる機能の設計を定義します。

この機能は、以下の主要コンポーネントで構成されます：

1. **ArtistSortMappingRepository**: 修正マッピングの永続化を担当
2. **ArtistSortGenerator（拡張）**: 修正マッピングを考慮したソート名生成
3. **ArtistSortCLI**: コマンドラインインターフェース
4. **修正マッピングファイル**: TSV形式でアーティスト名とソート名の対応を保存

## アーキテクチャ

### システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                      ユーザー                                 │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ コマンド実行
                        ▼
┌─────────────────────────────────────────────────────────────┐
│                  ArtistSortCLI                                │
│  - add_mapping()                                              │
│  - list_mappings()                                            │
│  - delete_mapping()                                           │
│  - update_mapping()                                           │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ 呼び出し
                        ▼
┌─────────────────────────────────────────────────────────────┐
│           ArtistSortMappingRepository                         │
│  - load_mappings()                                            │
│  - save_mapping()                                             │
│  - delete_mapping()                                           │
│  - get_all_mappings()                                         │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ 読み書き
                        ▼
┌─────────────────────────────────────────────────────────────┐
│              修正マッピングファイル                            │
│              (data/ARTIST_SORT_MAPPING.TSV)                   │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                  SongListService                              │
│  - generate_song_list()                                       │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ 使用
                        ▼
┌─────────────────────────────────────────────────────────────┐
│            ArtistSortGenerator（拡張）                        │
│  - generate()                                                 │
│  - set_mapping_repository()                                   │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        │ 参照
                        ▼
┌─────────────────────────────────────────────────────────────┐
│           ArtistSortMappingRepository                         │
└─────────────────────────────────────────────────────────────┘
```

### データフロー

1. **修正マッピングの追加フロー**:
   ```
   ユーザー → ArtistSortCLI → ArtistSortMappingRepository → ファイル保存
   ```

2. **曲リスト生成時のソート名生成フロー**:
   ```
   SongListService → ArtistSortGenerator → ArtistSortMappingRepository（マッピング確認）
                                         → pykakasi（自動変換）
   ```

## コンポーネントとインターフェース

### 1. ArtistSortMappingRepository

修正マッピングの永続化を担当するリポジトリクラス。

#### 責務
- 修正マッピングファイルの読み込み
- 修正マッピングの保存
- 修正マッピングの削除
- 全修正マッピングの取得

#### インターフェース

```python
class ArtistSortMappingRepository:
    """アーティスト名ソート修正マッピングのリポジトリ"""
    
    def __init__(self, file_path: str):
        """
        リポジトリを初期化
        
        Args:
            file_path: 修正マッピングファイルのパス
        """
        pass
    
    def load_mappings(self) -> Dict[str, str]:
        """
        修正マッピングをファイルから読み込む
        
        Returns:
            アーティスト名をキー、ソート名を値とする辞書
            
        Raises:
            FileNotFoundError: ファイルが存在しない場合（空の辞書を返す）
            ValueError: ファイル形式が不正な場合
        """
        pass
    
    def save_mapping(self, artist: str, sort_name: str) -> None:
        """
        修正マッピングを保存
        
        既存のマッピングがある場合は更新、ない場合は追加。
        
        Args:
            artist: アーティスト名
            sort_name: 正しいソート名
            
        Raises:
            IOError: ファイルへの書き込みに失敗した場合
        """
        pass
    
    def delete_mapping(self, artist: str) -> bool:
        """
        修正マッピングを削除
        
        Args:
            artist: アーティスト名
            
        Returns:
            削除に成功した場合True、該当するマッピングがない場合False
            
        Raises:
            IOError: ファイルへの書き込みに失敗した場合
        """
        pass
    
    def get_all_mappings(self) -> Dict[str, str]:
        """
        すべての修正マッピングを取得
        
        Returns:
            アーティスト名をキー、ソート名を値とする辞書
        """
        pass
    
    def get_mapping(self, artist: str) -> Optional[str]:
        """
        特定のアーティスト名の修正マッピングを取得
        
        Args:
            artist: アーティスト名
            
        Returns:
            ソート名（マッピングが存在しない場合はNone）
        """
        pass
```

### 2. ArtistSortGenerator（拡張）

既存の`ArtistSortGenerator`クラスを拡張し、修正マッピングを考慮したソート名生成を実装。

#### 変更点
- `ArtistSortMappingRepository`への参照を保持
- `generate()`メソッドで修正マッピングを優先的に適用

#### インターフェース

```python
class ArtistSortGenerator:
    """アーティスト名からソート用の読み仮名を生成するクラス"""
    
    def __init__(self, mapping_repository: Optional[ArtistSortMappingRepository] = None):
        """
        ArtistSortGeneratorを初期化
        
        Args:
            mapping_repository: 修正マッピングリポジトリ（オプション）
        """
        pass
    
    def generate(self, artist_name: str) -> str:
        """
        アーティスト名からソート用アーティスト名を生成
        
        修正マッピングが存在する場合はそれを使用し、
        存在しない場合は自動変換を行う。
        
        Args:
            artist_name: 元のアーティスト名
            
        Returns:
            ソート用アーティスト名
        """
        pass
    
    def set_mapping_repository(self, repository: ArtistSortMappingRepository) -> None:
        """
        修正マッピングリポジトリを設定
        
        Args:
            repository: 修正マッピングリポジトリ
        """
        pass
```

### 3. ArtistSortCLI

コマンドラインインターフェースを提供するクラス。

#### 責務
- ユーザーからのコマンド入力を受け付ける
- 修正マッピングの追加・更新・削除・一覧表示を実行
- 結果をユーザーに表示

#### インターフェース

```python
class ArtistSortCLI:
    """アーティスト名ソート修正のCLIインターフェース"""
    
    def __init__(self, repository: ArtistSortMappingRepository):
        """
        CLIを初期化
        
        Args:
            repository: 修正マッピングリポジトリ
        """
        pass
    
    def add_mapping(self, artist: str, sort_name: str) -> None:
        """
        修正マッピングを追加
        
        Args:
            artist: アーティスト名
            sort_name: 正しいソート名
        """
        pass
    
    def list_mappings(self) -> None:
        """すべての修正マッピングを表示"""
        pass
    
    def delete_mapping(self, artist: str) -> None:
        """
        修正マッピングを削除
        
        Args:
            artist: アーティスト名
        """
        pass
    
    def update_mapping(self, artist: str, sort_name: str) -> None:
        """
        修正マッピングを更新
        
        Args:
            artist: アーティスト名
            sort_name: 新しいソート名
        """
        pass
    
    def run(self) -> None:
        """CLIのメインループを実行"""
        pass
```

## データモデル

### 修正マッピングファイル形式

**ファイルパス**: `data/ARTIST_SORT_MAPPING.TSV`

**形式**: TSV（タブ区切り）

**エンコーディング**: UTF-8

**構造**:
```
アーティスト名	ソート名
Vaundy	Vaundy
米津玄師	よねづけんし
Official髭男dism	おふぃしゃるひげだんでぃずむ
```

**ルール**:
- 1行目はヘッダー行
- 2行目以降がデータ行
- 各行はタブ文字で区切られた2つのフィールドを持つ
- 空行は無視される
- 重複したアーティスト名がある場合、最後のエントリが有効

### データモデルクラス

```python
@dataclass
class ArtistSortMapping:
    """アーティスト名ソート修正マッピング"""
    artist: str  # アーティスト名
    sort_name: str  # ソート名
```


## Correctness Properties

*プロパティとは、システムのすべての有効な実行において真であるべき特性や動作のことです。プロパティは、人間が読める仕様と機械的に検証可能な正しさの保証との橋渡しをします。*

### Property 1: ファイル読み込みの往復一貫性

*任意の*有効なマッピング辞書について、それをファイルに保存してから読み込むと、元の辞書と等しい辞書が得られる

**検証: 要件 1.1, 1.4**

### Property 2: マッピング追加の永続性

*任意の*アーティスト名とソート名について、マッピングを追加した後にファイルから読み込むと、そのマッピングが含まれている

**検証: 要件 1.4**

### Property 3: マッピング更新の上書き

*任意の*既存のマッピングについて、新しいソート名で更新した後にファイルから読み込むと、新しいソート名が使用されている

**検証: 要件 1.5**

### Property 4: マッピング削除の除去

*任意の*既存のマッピングについて、削除した後にファイルから読み込むと、そのマッピングは含まれていない

**検証: 要件 3.3**

### Property 5: マッピング優先の適用

*任意の*アーティスト名について、そのアーティスト名に対するマッピングが存在する場合、generate()はマッピングのソート名を返す

**検証: 要件 2.1**

### Property 6: 自動生成のフォールバック

*任意の*アーティスト名について、そのアーティスト名に対するマッピングが存在しない場合、generate()は自動生成されたソート名を返す

**検証: 要件 2.2**

### Property 7: 不正形式のエラー処理

*任意の*不正な形式のファイルについて、読み込もうとするとValueErrorが発生する

**検証: 要件 1.3**

## エラーハンドリング

### エラーの種類と処理方針

1. **ファイル不存在エラー**
   - 発生条件: 修正マッピングファイルが存在しない
   - 処理: 空のマッピングとして処理を続行
   - ログレベル: INFO
   - メッセージ例: "修正マッピングファイルが見つかりません。空のマッピングとして処理します。"

2. **ファイル形式エラー**
   - 発生条件: TSV形式が不正、カラム数が不足
   - 処理: ValueErrorを発生させて処理を中断
   - ログレベル: ERROR
   - メッセージ例: "修正マッピングファイルの形式が不正です: {詳細}"

3. **ファイル書き込みエラー**
   - 発生条件: ファイルへの書き込み権限がない、ディスク容量不足
   - 処理: IOErrorを発生させて処理を中断
   - ログレベル: ERROR
   - メッセージ例: "修正マッピングファイルへの書き込みに失敗しました: {詳細}"

4. **エンコーディングエラー**
   - 発生条件: UTF-8以外のエンコーディングでファイルが保存されている
   - 処理: UnicodeDecodeErrorを発生させて処理を中断
   - ログレベル: ERROR
   - メッセージ例: "修正マッピングファイルのエンコーディングが不正です。UTF-8で保存してください。"

5. **マッピング不存在エラー**
   - 発生条件: 存在しないアーティスト名のマッピングを削除しようとした
   - 処理: Falseを返す（エラーではなく正常な結果）
   - ログレベル: WARNING
   - メッセージ例: "削除対象のマッピングが見つかりません: {アーティスト名}"

### エラーハンドリングの実装方針

- すべてのファイルI/O操作はtry-exceptブロックで囲む
- エラーメッセージには具体的な原因と対処方法を含める
- ログには適切なレベル（INFO, WARNING, ERROR）を使用
- ユーザー向けのエラーメッセージは日本語で表示
- 開発者向けのログメッセージは英語でも可

## テスト戦略

### ユニットテスト

ユニットテストは、各コンポーネントの具体的な動作を検証します。

#### ArtistSortMappingRepositoryのテスト

1. **ファイル読み込みテスト**
   - 正常なTSVファイルの読み込み
   - 空ファイルの読み込み
   - 存在しないファイルの読み込み

2. **ファイル書き込みテスト**
   - 新規マッピングの追加
   - 既存マッピングの更新
   - マッピングの削除

3. **エラーハンドリングテスト**
   - 不正な形式のファイル
   - 書き込み権限のないパス
   - エンコーディングエラー

#### ArtistSortGeneratorのテスト

1. **マッピング適用テスト**
   - マッピングが存在する場合
   - マッピングが存在しない場合
   - マッピングリポジトリが設定されていない場合

2. **自動変換テスト**
   - 日本語アーティスト名の変換
   - 英語アーティスト名の変換
   - 混在アーティスト名の変換

#### ArtistSortCLIのテスト

1. **コマンド実行テスト**
   - add_mapping()の実行
   - list_mappings()の実行
   - delete_mapping()の実行
   - update_mapping()の実行

2. **エラーケーステスト**
   - 存在しないマッピングの削除
   - 不正な引数の処理

### プロパティベーステスト

プロパティベーステストは、すべての入力に対して成り立つべき普遍的な性質を検証します。

#### テストライブラリ

Pythonの**Hypothesis**ライブラリを使用します。

#### テスト設定

- 各プロパティテストは最低**100回**の反復を実行
- ランダムなアーティスト名とソート名を生成
- ファイルI/Oを含むテストは一時ファイルを使用

#### プロパティテストの実装

各Correctness Propertyに対して、以下の形式でプロパティテストを実装します：

```python
from hypothesis import given, strategies as st

@given(
    artist=st.text(min_size=1, max_size=100),
    sort_name=st.text(min_size=1, max_size=100)
)
def test_property_mapping_persistence(artist, sort_name):
    """
    Feature: artist-sort-correction, Property 2: マッピング追加の永続性
    
    任意のアーティスト名とソート名について、マッピングを追加した後に
    ファイルから読み込むと、そのマッピングが含まれている
    """
    # テスト実装
    pass
```

#### プロパティテストのタグ付け

各プロパティテストには、以下の形式でコメントを付与します：

```
Feature: artist-sort-correction, Property {番号}: {プロパティ名}
```

これにより、設計書のCorrectness Propertyとテストコードの対応関係が明確になります。

### 統合テスト

統合テストは、複数のコンポーネントが連携して正しく動作することを検証します。

1. **曲リスト生成との統合**
   - SongListServiceが修正マッピングを正しく適用すること
   - 修正マッピングが曲リストのソート順に反映されること

2. **CLIとリポジトリの統合**
   - CLIコマンドがリポジトリを正しく操作すること
   - ファイルへの変更が正しく永続化されること

### テストデータ

#### 正常系テストデータ

```tsv
アーティスト名	ソート名
Vaundy	Vaundy
米津玄師	よねづけんし
Official髭男dism	おふぃしゃるひげだんでぃずむ
```

#### 異常系テストデータ

1. **カラム数不足**
```tsv
アーティスト名	ソート名
Vaundy
```

2. **ヘッダーなし**
```tsv
Vaundy	Vaundy
```

3. **空行を含む**
```tsv
アーティスト名	ソート名
Vaundy	Vaundy

米津玄師	よねづけんし
```

4. **重複エントリ**
```tsv
アーティスト名	ソート名
Vaundy	Vaundy
Vaundy	ばうんでぃ
```

## 実装の詳細

### ファイルパス

- デフォルトパス: `data/ARTIST_SORT_MAPPING.TSV`
- 環境変数での上書き: `ARTIST_SORT_MAPPING_FILE`

### ログ出力

- ロガー名: `src.repositories.artist_sort_mapping_repository`
- ログレベル:
  - INFO: 正常な操作（ファイル読み込み、マッピング追加など）
  - WARNING: 警告（マッピング不存在など）
  - ERROR: エラー（ファイル形式エラー、書き込みエラーなど）

### パフォーマンス考慮事項

- マッピングファイルは起動時に一度だけ読み込む
- メモリ上にマッピングをキャッシュする
- ファイルへの書き込みは即座に実行（遅延書き込みなし）

### 後方互換性

- 既存の`ArtistSortGenerator`の動作は変更しない
- `mapping_repository`が設定されていない場合は従来通りの動作
- 既存のテストはすべて成功する

## セキュリティ考慮事項

1. **ファイルパスの検証**
   - ユーザー入力のファイルパスはサニタイズする
   - ディレクトリトラバーサル攻撃を防ぐ

2. **ファイルアクセス権限**
   - 修正マッピングファイルは適切な権限で作成（644）
   - 他のユーザーによる書き込みを防ぐ

3. **入力検証**
   - アーティスト名とソート名の長さを制限
   - 特殊文字のエスケープ処理

## 将来の拡張性

1. **バックアップ機能**
   - 修正マッピングファイルの自動バックアップ
   - 変更履歴の記録

2. **一括インポート/エクスポート**
   - 複数のマッピングを一度に追加
   - 既存のマッピングをエクスポート

3. **Web UI**
   - ブラウザから修正マッピングを管理
   - Streamlitアプリへの統合

4. **自動修正提案**
   - 類似性チェックの結果から修正候補を提案
   - 機械学習による読み仮名の改善
