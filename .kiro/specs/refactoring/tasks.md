# リファクタリング実装タスクリスト

このタスクリストは、「しのうたタイム」アプリケーションのリファクタリングを段階的に実行するための実装計画です。各タスクは前のタスクの成果物を基に構築され、最終的に保守性・テスト可能性・拡張性の高いコードベースを実現します。

## タスク一覧

- [ ] 1. プロジェクト構造の準備
  - srcディレクトリ構造を作成する
  - 各サブディレクトリ（services、core、ui、config、exceptions）を作成する
  - 各ディレクトリに__init__.pyを配置する
  - testsディレクトリを作成する
  - _要件: 1.1, 2.1, 3.1, 4.1, 5.1, 6.1, 7.1, 8.1_

- [ ] 2. 設定管理モジュールの実装
  - [ ] 2.1 Configクラスの実装
    - config/settings.pyにConfigクラスを実装する
    - ファイルパス、表示設定、ページ設定、パフォーマンス設定を定義する
    - from_env()メソッドで環境変数からの設定読み込みを実装する
    - validate()メソッドで設定値の検証を実装する
    - _要件: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 6.7_

- [ ] 3. カスタム例外モジュールの実装
  - [ ] 3.1 例外クラスの実装
    - exceptions/errors.pyに基底例外クラスShinoutaTimeErrorを実装する
    - DataLoadError、DataProcessingError、ConfigurationErrorを実装する
    - log_error()関数を実装する
    - _要件: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7_

- [ ] 4. ユーティリティ関数の実装
  - [ ] 4.1 タイムスタンプ変換関数の実装
    - core/utils.pyにconvert_timestamp_to_seconds()を実装する
    - HH:MM:SS形式とMM:SS形式の両方に対応する
    - _要件: 3.2, 3.7_
  
  - [ ] 4.2 URL生成関数の実装
    - generate_youtube_url()を実装する
    - タイムスタンプ付きYouTube URLを生成する
    - _要件: 3.3, 3.7_
  
  - [ ] 4.3 曲目番号生成関数の実装
    - generate_song_numbers()を実装する
    - 配信ごとの曲順と配信番号を計算する
    - _要件: 3.4, 3.7_
  
  - [ ] 4.4 日付変換関数の実装
    - convert_date_string()を実装する
    - UNIXミリ秒とYYYY/MM/DD形式の両方に対応する
    - _要件: 3.5, 3.7_

- [ ]* 4.5 ユーティリティ関数のプロパティテスト
  - **プロパティ1: タイムスタンプ変換の可逆性**
  - **検証: 要件 3.2**
  - 有効なタイムスタンプ文字列を秒数に変換し、再度文字列に戻した場合、元の値と等価であること

- [ ]* 4.6 ユーティリティ関数の単体テスト
  - convert_timestamp_to_seconds()のテストを作成する
  - generate_youtube_url()のテストを作成する
  - generate_song_numbers()のテストを作成する
  - convert_date_string()のテストを作成する
  - エッジケース（None、空文字列、不正な形式）をテストする
  - _要件: 8.2, 8.4, 8.6_

- [ ] 5. データサービスの実装
  - [ ] 5.1 DataServiceクラスの実装
    - services/data_service.pyにDataServiceクラスを実装する
    - load_lives_data()メソッドを実装する
    - load_songs_data()メソッドを実装する
    - load_song_list_data()メソッドを実装する
    - merge_data()メソッドを実装する
    - get_last_error()メソッドを実装する
    - エラーハンドリングを実装する（DataLoadErrorを使用）
    - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 1.7_

- [ ]* 5.2 DataServiceのプロパティテスト
  - **プロパティ2: データ結合の整合性**
  - **検証: 要件 1.4**
  - 任意の配信データと楽曲データを結合した場合、結合後の行数は楽曲データの行数と等しいこと（左結合）

- [ ]* 5.3 DataServiceの単体テスト
  - load_lives_data()のテストを作成する
  - load_songs_data()のテストを作成する
  - load_song_list_data()のテストを作成する
  - merge_data()のテストを作成する
  - ファイルが存在しない場合のエラーハンドリングをテストする
  - _要件: 8.2, 8.4, 8.6_

- [ ] 6. 検索サービスの実装
  - [ ] 6.1 SearchServiceクラスの実装
    - services/search_service.pyにSearchServiceクラスを実装する
    - search()メソッドを実装する（複数フィールド対応）
    - filter_by_multiple_conditions()メソッドを実装する
    - 大文字小文字を区別しない検索を実装する
    - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7_

- [ ]* 6.2 SearchServiceのプロパティテスト
  - **プロパティ3: 検索結果の包含性**
  - **検証: 要件 2.3, 2.5**
  - 任意のデータフレームとクエリに対して、検索結果の全ての行は検索条件を満たすこと

- [ ]* 6.3 SearchServiceの単体テスト
  - search()メソッドのテストを作成する
  - filter_by_multiple_conditions()のテストを作成する
  - 大文字小文字を区別しない検索のテストを作成する
  - 空の検索結果のテストを作成する
  - _要件: 8.3, 8.4, 8.6_

- [ ] 7. データパイプラインの実装
  - [ ] 7.1 DataPipelineクラスの実装
    - core/data_pipeline.pyにDataPipelineクラスを実装する
    - execute()メソッドを実装する（全体フロー）
    - _load_data()メソッドを実装する
    - _merge_data()メソッドを実装する
    - _transform_data()メソッドを実装する（タイムスタンプ変換、日付変換、URL生成、曲目番号生成）
    - _sort_data()メソッドを実装する
    - _validate_step_result()メソッドを実装する
    - clear_cache()メソッドを実装する
    - キャッシング機能を実装する
    - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 12.1_

- [ ]* 7.2 DataPipelineのプロパティテスト
  - **プロパティ4: パイプライン実行の冪等性**
  - **検証: 要件 4.6**
  - キャッシュが有効な場合、同じパイプラインを複数回実行しても同じ結果が返されること

- [ ]* 7.3 DataPipelineの単体テスト
  - execute()メソッドのテストを作成する
  - 各ステップ（_load_data、_merge_data、_transform_data、_sort_data）のテストを作成する
  - _validate_step_result()のテストを作成する
  - キャッシング機能のテストを作成する
  - エラーハンドリングのテストを作成する
  - _要件: 8.5, 8.4, 8.6_

- [ ] 8. UIコンポーネントの実装
  - [ ] 8.1 検索フォームコンポーネントの実装
    - ui/components.pyにrender_search_form()を実装する
    - テキスト入力、チェックボックス、検索ボタンを含む
    - _要件: 5.1, 5.2, 5.6, 5.7_
  
  - [ ] 8.2 結果テーブルコンポーネントの実装
    - render_results_table()を実装する
    - HTMLテーブル生成とカスタムヘッダー対応を実装する
    - _要件: 5.1, 5.3, 5.6, 5.7_
  
  - [ ] 8.3 ページネーションコンポーネントの実装
    - render_pagination()を実装する
    - 「さらに表示」ボタンと件数表示を実装する
    - _要件: 5.1, 5.4, 5.6, 5.7_
  
  - [ ] 8.4 Twitter埋め込みコンポーネントの実装
    - render_twitter_embed()を実装する
    - ファイルからの埋め込みコード読み込みを実装する
    - _要件: 5.1, 5.5, 5.6, 5.7_

- [ ] 9. ロギング機能の追加
  - [ ] 9.1 ロギング設定の実装
    - 各モジュールにloggingを追加する
    - ログレベル（DEBUG、INFO、WARNING、ERROR）を適切に使用する
    - データ読み込み時のログを追加する
    - エラー発生時の詳細ログを追加する
    - _要件: 13.1, 13.2, 13.3, 13.4, 13.5, 13.6, 13.7_

- [ ] 10. Home.pyのリファクタリング
  - [ ] 10.1 Home.pyの簡潔化
    - 新しいモジュールを使用してHome.pyを書き換える
    - DataPipelineを使用してデータ処理を実行する
    - SearchServiceを使用して検索機能を実装する
    - UIコンポーネントを使用してUIを構築する
    - コード行数を約500行から約100行に削減する
    - 既存の機能を全て維持する
    - _要件: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7, 11.1, 11.2, 11.3, 11.4, 11.5, 11.6, 11.7_

- [ ] 11. チェックポイント1 - コア機能のテスト
  - 全てのテストが通過することを確認する
  - Home.pyが正常に動作することを確認する
  - 質問があればユーザーに確認する

- [ ] 12. pages/01_Information.pyのリファクタリング
  - [ ] 12.1 01_Information.pyの簡潔化
    - UIコンポーネント（render_twitter_embed）を使用する
    - 重複コードを削減する
    - 既存の機能を全て維持する
    - _要件: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7_

- [ ] 13. pages/99_Song_List_beta.pyのリファクタリング
  - [ ] 13.1 99_Song_List_beta.pyの簡潔化
    - DataServiceを使用してデータ読み込みを実装する
    - UIコンポーネントを使用してテーブル表示を実装する
    - 重複コードを削減する
    - 既存の機能を全て維持する
    - _要件: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7_

- [ ] 14. パフォーマンス最適化
  - [ ] 14.1 キャッシング戦略の実装
    - Streamlitの@st.cache_dataを適切に使用する
    - DataPipelineのキャッシュを最適化する
    - 初期表示時間を3秒以内に保つ
    - 検索応答時間を1秒以内に保つ
    - _要件: 12.1, 12.2, 12.3, 12.4, 12.5, 12.6, 12.7_

- [ ] 15. チェックポイント2 - 全体テスト
  - 全てのテストが通過することを確認する
  - 全てのページが正常に動作することを確認する
  - パフォーマンス要件を満たしていることを確認する
  - 質問があればユーザーに確認する

- [ ] 16. ドキュメントの更新
  - [ ] 16.1 README.mdの更新
    - 新しいモジュール構造を説明する
    - 各モジュールの責務を明確にする
    - 開発者向けガイドを更新する
    - _要件: 9.1, 9.2, 9.3, 9.4_
  
  - [ ] 16.2 アーキテクチャドキュメントの更新
    - docs/architecture.mdを更新する
    - アーキテクチャ図を更新する
    - レイヤー構造を説明する
    - _要件: 9.5_
  
  - [ ] 16.3 開発者ガイドの更新
    - docs/developer-guide.mdを更新する
    - 新しいモジュールの使用方法を説明する
    - テストの実行方法を説明する
    - _要件: 9.4, 9.7_

- [ ] 17. 最終チェックポイント
  - 全てのテストが通過することを確認する
  - 全ての要件が満たされていることを確認する
  - 後方互換性が維持されていることを確認する
  - パフォーマンスが維持または改善されていることを確認する
  - 質問があればユーザーに確認する

## 注意事項

- 各タスクは順番に実行してください
- タスクに「*」が付いているものはオプションです（テスト関連）
- チェックポイントでは必ず動作確認を行ってください
- 既存の機能を壊さないように注意してください
- 質問や不明点があれば、いつでもユーザーに確認してください
