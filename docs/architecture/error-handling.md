# エラーハンドリングガイド

## 概要

このドキュメントは、「しのうたタイム」アプリケーションで発生する可能性のあるエラーとその対処方法について説明します。アプリケーションは、ユーザーに分かりやすいエラーメッセージを表示し、可能な限り動作を継続するように設計されています。

## エラーレベルの分類

アプリケーションでは、エラーの重要度に応じて3つのレベルでメッセージを表示します。

### 1. Error（エラー）

**表示方法**: `st.error()`

**意味**: 重大な問題が発生し、機能が正常に動作できない状態です。

**特徴**:
- 赤色の背景で表示される
- ユーザーの操作や設定変更が必要
- 該当機能が使用できない状態

**使用例**:
- 必須ファイルが見つからない
- ファイルの読み込みに失敗した
- データの形式が不正

### 2. Warning（警告）

**表示方法**: `st.warning()`

**意味**: 問題が発生したが、アプリケーションは動作を継続できる状態です。

**特徴**:
- 黄色の背景で表示される
- 一部機能に制限がある可能性
- デフォルト値や代替手段で動作継続

**使用例**:
- データ変換時の一部エラー
- 設定ファイルが見つからないがデフォルト値で継続
- 非推奨の形式のデータ

### 3. Info（情報）

**表示方法**: `st.info()`

**意味**: エラーではなく、ユーザーへの情報提供や補足説明です。

**特徴**:
- 青色の背景で表示される
- 問題ではなく、状態の通知
- 対処不要な場合が多い

**使用例**:
- オプション機能が利用できない旨の通知
- 操作方法の案内
- 全件表示完了の通知

---

## エラーの種類と対処方法

### ファイル読み込みエラー

#### 1. TSVファイルが見つからない

**エラーメッセージ例**:
```
エラー: 配信情報ファイル "data/M_YT_LIVE.TSV" が見つかりません。
```

**発生原因**:
- 必要なTSVファイルが指定された場所に存在しない
- ファイル名が間違っている
- ディレクトリ構造が正しくない

**対処方法**:
1. `data/` ディレクトリが存在するか確認する
2. 以下のファイルが正しく配置されているか確認する:
   - `data/M_YT_LIVE.TSV`（配信情報）
   - `data/M_YT_LIVE_TIMESTAMP.TSV`（楽曲タイムスタンプ情報）
   - `data/V_SONG_LIST.TSV`（楽曲リスト）
3. ファイル名の大文字小文字が正しいか確認する（特にLinux環境）
4. ファイルのパーミッション（読み取り権限）を確認する

**補足情報メッセージ**:
```
`data/M_YT_LIVE.TSV` がアプリと同じディレクトリにあるか確認してください。
```

**該当ファイル**:
- `Home.py`: 配信情報と楽曲情報の読み込み
- `pages/99_Song_List_beta.py`: 楽曲リスト情報の読み込み

**要件**: 1.3, 1.4, 13.1

---

#### 2. TSVファイルの読み込み中のエラー

**エラーメッセージ例**:
```
配信情報ファイル "data/M_YT_LIVE.TSV" の読み込み中にエラーが発生しました: [詳細なエラー内容]
```

**発生原因**:
- ファイルの形式が不正（TSV形式でない）
- ファイルが破損している
- 文字エンコーディングの問題
- ファイルが他のプログラムで使用中

**対処方法**:
1. ファイルをテキストエディタで開き、タブ区切り形式になっているか確認する
2. ファイルのエンコーディングがUTF-8であることを確認する
3. ファイルを再ダウンロードまたは再作成する
4. ファイルが他のプログラムで開かれていないか確認する
5. エラーメッセージの詳細を確認し、具体的な問題を特定する

**該当ファイル**:
- `Home.py`: 配信情報と楽曲情報の読み込み
- `pages/99_Song_List_beta.py`: 楽曲リスト情報の読み込み

**要件**: 1.4, 13.1

---

#### 3. CSSファイルが見つからない

**エラーメッセージ例**:
```
エラー: style.css が見つかりません。
```

**発生原因**:
- `style.css` ファイルが存在しない
- ファイルの配置場所が間違っている

**対処方法**:
1. `style.css` がアプリケーションのルートディレクトリに存在するか確認する
2. ファイル名が正確に `style.css` であることを確認する（大文字小文字に注意）
3. ファイルのパーミッション（読み取り権限）を確認する

**補足情報メッセージ**:
```
`style.css` がアプリと同じディレクトリにあるか確認してください。
```

**影響**:
- CSSファイルが読み込めなくても、アプリケーションは動作を継続します
- ただし、カスタムスタイルが適用されないため、見た目が標準的なStreamlitのデザインになります

**該当ファイル**:
- `Home.py`: カスタムCSSの読み込み

**要件**: 13.2

---

#### 4. CSSファイルの読み込み中のエラー

**エラーメッセージ例**:
```
エラー: style.css の読み込み中に問題が発生しました: [詳細なエラー内容]
```

**発生原因**:
- ファイルの文字エンコーディングの問題
- ファイルが破損している
- ファイルアクセス権限の問題

**対処方法**:
1. ファイルのエンコーディングがUTF-8であることを確認する
2. ファイルをテキストエディタで開き、内容が正常か確認する
3. ファイルを再作成する
4. エラーメッセージの詳細を確認し、具体的な問題を特定する

**該当ファイル**:
- `Home.py`: カスタムCSSの読み込み

**要件**: 13.2

---

#### 5. Twitter埋め込みファイルが見つからない

**情報メッセージ例**:
```
情報: 表示するコンテンツがありません。（tweet_embed_code.html）
```

**発生原因**:
- `data/tweet_embed_code.html` ファイルが存在しない
- ファイルの配置場所が間違っている

**対処方法**:
1. `data/tweet_embed_code.html` が存在するか確認する
2. ファイルが空でないか確認する
3. Twitter埋め込みコードが正しく記述されているか確認する

**影響**:
- Twitter埋め込みが表示されないだけで、他の機能は正常に動作します
- エラーではなく情報メッセージとして表示されます

**該当ファイル**:
- `pages/01_Information.py`: Twitter埋め込み表示

**要件**: 9.5, 13.1

---

### データ処理エラー

#### 6. 日付変換エラー

**警告メッセージ例**:
```
ソート用の「ライブ配信日」変換中にエラーが発生しました: [詳細なエラー内容]
```

**発生原因**:
- 配信日のデータ形式が想定外
- UNIXミリ秒形式でもYYYY/MM/DD形式でもない日付データ
- 日付データが欠損または不正

**対処方法**:
1. `data/M_YT_LIVE.TSV` の「配信日」列のデータ形式を確認する
2. 日付データが以下のいずれかの形式であることを確認する:
   - UNIXミリ秒（例: 1609459200000）
   - YYYY/MM/DD形式（例: 2021/01/01）
3. 不正なデータがある場合は修正する

**補足警告メッセージ**:
```
日付の形式が複雑な可能性があります。TSVファイル内の「配信日」カラムのデータを直接確認してください。
```

**影響**:
- 日付のソート順が正しくない可能性があります
- 検索機能やその他の機能は正常に動作します

**該当ファイル**:
- `Home.py`: 日付データの変換とソート処理

**要件**: 13.3

---

#### 7. Twitter埋め込み高さ設定エラー

**警告メッセージ例**:
```
警告: 'data/tweet_height.txt' に無効な高さが指定されています。デフォルト値 (850px) を使用します。
```

**発生原因**:
- `data/tweet_height.txt` の内容が数値でない
- ファイルに不正な文字が含まれている

**対処方法**:
1. `data/tweet_height.txt` を開く
2. 内容が数値のみ（例: `850`）であることを確認する
3. 余分な空白や改行、文字が含まれていないか確認する
4. 必要に応じてファイルを修正する

**影響**:
- デフォルトの高さ（850ピクセル）で表示されます
- 機能自体は正常に動作します

**該当ファイル**:
- `pages/01_Information.py`: Twitter埋め込み表示

**要件**: 13.3

---

#### 8. Twitter埋め込み高さファイル読み込みエラー

**警告メッセージ例**:
```
警告: 高さ設定ファイルの読み込み中にエラーが発生しました: [詳細なエラー内容]。デフォルト値 (850px) を使用します。
```

**発生原因**:
- ファイルアクセス権限の問題
- ファイルが破損している
- 文字エンコーディングの問題

**対処方法**:
1. ファイルのパーミッション（読み取り権限）を確認する
2. ファイルを再作成する
3. エラーメッセージの詳細を確認し、具体的な問題を特定する

**影響**:
- デフォルトの高さ（850ピクセル）で表示されます
- 機能自体は正常に動作します

**該当ファイル**:
- `pages/01_Information.py`: Twitter埋め込み表示

**要件**: 13.3

---

### 検索・表示関連

#### 9. 検索結果が0件

**表示メッセージ例**:
```
「キーワード」で検索した結果: 0件
```

**発生原因**:
- 検索キーワードに一致する楽曲が存在しない
- 検索キーワードのスペルミス
- 全角・半角の違い

**対処方法**:
1. 検索キーワードのスペルを確認する
2. より短いキーワードで検索する（部分一致検索のため）
3. 全角・半角を変えて試す
4. 「検索対象にライブ配信タイトルを含める」チェックボックスを試す

**影響**:
- エラーではなく、正常な検索結果です
- 検索条件を変更して再度検索できます

**該当ファイル**:
- `Home.py`: 検索機能

**要件**: 2.7

---

#### 10. データ結合失敗

**警告メッセージ例**:
```
必要なTSVファイルがすべて読み込めなかったため、結合データは表示できません。
```

**発生原因**:
- 配信情報ファイルまたは楽曲情報ファイルの読み込みに失敗した
- 両方のファイルが正常に読み込めない

**対処方法**:
1. 上記の「TSVファイルが見つからない」または「TSVファイルの読み込み中のエラー」の対処方法を参照する
2. 両方のファイルが正しく配置されているか確認する:
   - `data/M_YT_LIVE.TSV`
   - `data/M_YT_LIVE_TIMESTAMP.TSV`

**影響**:
- メインページの検索機能が使用できません
- 他のページ（情報ページ、About Usページ、楽曲リストページ）は正常に動作します

**該当ファイル**:
- `Home.py`: データ結合処理

**要件**: 1.5, 13.4

---

## エラーハンドリングの設計方針

### 1. ユーザーフレンドリーなメッセージ

- 技術的な詳細よりも、ユーザーが理解しやすい言葉を使用
- 具体的な対処方法を提示
- 必要に応じて補足情報を追加

### 2. 動作の継続

- 可能な限りアプリケーションの動作を継続
- 一部機能のエラーが全体に影響しないように設計
- デフォルト値や代替手段を用意

### 3. 適切なエラーレベル

- エラーの重要度に応じて適切なレベルを使用
- ユーザーの操作が必要な場合は `error`
- 動作継続可能な場合は `warning`
- 情報提供のみの場合は `info`

### 4. エラー情報の保持

- エラーの詳細情報を表示
- トラブルシューティングに必要な情報を提供
- 必要に応じて元のエラーメッセージを含める

---

## トラブルシューティング

### 一般的な確認事項

1. **ファイル構造の確認**
   ```
   しのうたタイム/
   ├── Home.py
   ├── style.css
   ├── footer.py
   ├── data/
   │   ├── M_YT_LIVE.TSV
   │   ├── M_YT_LIVE_TIMESTAMP.TSV
   │   ├── V_SONG_LIST.TSV
   │   ├── tweet_embed_code.html
   │   └── tweet_height.txt
   └── pages/
       ├── 01_Information.py
       ├── 02_About_Us.py
       └── 99_Song_List_beta.py
   ```

2. **ファイルのエンコーディング**
   - すべてのファイルがUTF-8エンコーディングであることを確認

3. **ファイルのパーミッション**
   - すべてのファイルに読み取り権限があることを確認

4. **Streamlitの再起動**
   - エラーが解決しない場合、Streamlitアプリケーションを再起動する
   - ブラウザのキャッシュをクリアする

### よくある問題と解決方法

#### 問題: アプリケーションが起動しない

**確認事項**:
1. Python環境が正しくセットアップされているか
2. 必要なパッケージがインストールされているか（`pip install -r requirements.txt`）
3. `Home.py` が存在するか
4. コマンドが正しいか（`streamlit run Home.py`）

#### 問題: データが表示されない

**確認事項**:
1. すべてのTSVファイルが正しく配置されているか
2. TSVファイルの形式が正しいか（タブ区切り）
3. TSVファイルに必要な列が存在するか
4. エラーメッセージが表示されていないか確認

#### 問題: スタイルが適用されない

**確認事項**:
1. `style.css` が存在するか
2. ブラウザのキャッシュをクリアしたか
3. エラーメッセージが表示されていないか確認

#### 問題: Twitter埋め込みが表示されない

**確認事項**:
1. `data/tweet_embed_code.html` が存在するか
2. ファイルに有効なTwitter埋め込みコードが含まれているか
3. インターネット接続が正常か（Twitter APIへのアクセスが必要）

---

## 開発者向け情報

### エラーハンドリングの実装パターン

#### パターン1: ファイル読み込み

```python
try:
    df = pd.read_csv(file_path, delimiter="\t")
except FileNotFoundError:
    st.error(f'エラー: ファイル "{file_path}" が見つかりません。')
    st.info(f"`{file_path}` が正しく配置されているか確認してください。")
except Exception as e:
    st.error(f'ファイル "{file_path}" の読み込み中にエラー: {e}')
```

#### パターン2: データ変換

```python
try:
    # データ変換処理
    df["column"] = pd.to_datetime(df["column"], errors="coerce")
except Exception as e:
    st.warning(f"データ変換中にエラーが発生しました: {e}")
    # デフォルト値や代替処理を実行
```

#### パターン3: オプション機能

```python
try:
    with open(optional_file_path, "r", encoding="utf-8") as f:
        content = f.read()
except FileNotFoundError:
    st.info(f"情報: 表示するコンテンツがありません。")
    return  # 処理を中断するが、エラーではない
```

### 新しいエラーハンドリングの追加

新しい機能を追加する際は、以下のガイドラインに従ってください:

1. **適切なエラーレベルを選択**
   - 機能が使用できない: `st.error()`
   - 動作継続可能: `st.warning()`
   - 情報提供のみ: `st.info()`

2. **ユーザーフレンドリーなメッセージ**
   - 何が起きたかを明確に説明
   - 対処方法を提示
   - 技術的な詳細は必要に応じて追加

3. **動作の継続**
   - 可能な限りアプリケーションを停止させない
   - デフォルト値や代替手段を用意
   - 部分的な機能低下で対応

4. **ドキュメントの更新**
   - 新しいエラーをこのドキュメントに追加
   - 対処方法を明確に記述
   - 該当する要件番号を記載

---

## 関連ドキュメント

- [開発者ガイド](developer-guide.md): プロジェクト構造とコーディング規約
- [データ管理ガイド](data-management.md): TSVファイルの形式と管理方法
- [ユーザーガイド](user-guide.md): アプリケーションの使い方
- [FAQ](faq.md): よくある質問と回答

---

## 要件との対応

このドキュメントは以下の要件を満たしています:

- **要件13.1**: ファイル読み込みエラー時のエラーメッセージ表示
- **要件13.2**: CSSファイルが見つからない場合のエラーメッセージと対処方法表示
- **要件13.3**: データ変換エラー時の警告メッセージ表示
- **要件13.4**: エラー発生時もアプリケーションの動作を継続
- **要件13.5**: エラーの種類に応じた適切なメッセージレベル（error/warning/info）の使用

---

**最終更新日**: 2025年11月18日
