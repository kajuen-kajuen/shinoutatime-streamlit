# 要件定義書：ローカル環境構築

## はじめに

本ドキュメントは、「しのうたタイム」アプリケーションをローカル端末で動作させるための環境構築手順を定義します。

## 用語集

- **ローカル端末**: 開発者またはユーザーの個人コンピュータ
- **Python環境**: Pythonインタープリタとパッケージ管理システムが動作する環境
- **依存パッケージ**: アプリケーションの動作に必要な外部ライブラリ
- **Streamlit**: Pythonで記述されたWebアプリケーションフレームワーク
- **Streamlit Cloud**: Streamlitアプリケーションのホスティングサービス
- **本番環境**: shinoutatime.streamlit.app で公開されているアプリケーション環境（mainブランチ）
- **ステージング環境**: stg-shinoutatime.streamlit.app で公開されているテスト環境（developブランチ）
- **データメンテナンスブランチ**: update-dataブランチ（データファイルの更新専用）
- **TSVファイル**: タブ区切りのテキストデータファイル
- **環境変数**: オペレーティングシステムレベルで設定される設定値
- **Docker**: コンテナ型仮想化技術
- **Dev Container**: VS Codeの開発コンテナ機能

## 要件

### 要件1：環境構築方法の選択

**ユーザーストーリー**: 開発者として、ローカル環境を汚さずにアプリケーションを実行する方法を選択したい。そうすることで、システムの依存関係を分離し、クリーンな環境を維持できる。

#### 受入基準

1. WHEN 開発者が環境構築方法を検討する THEN システムはDockerコンテナを使用した方法を提供する
2. WHEN 開発者が環境構築方法を検討する THEN システムはPython仮想環境を使用した方法を提供する
3. WHEN 開発者が環境構築方法を検討する THEN システムは各方法のメリットとデメリットを説明する
4. WHERE 環境の分離が重要である THEN システムはDockerコンテナの使用を推奨する

### 要件2：Dockerコンテナを使用した環境構築

**ユーザーストーリー**: 開発者として、Dockerコンテナを使用してアプリケーションを実行したい。そうすることで、ローカル環境にPythonや依存パッケージをインストールせずに済む。

#### 受入基準

1. WHEN 開発者がDockerをインストールする THEN システムはDocker Desktopまたはdocker-ceを利用可能にする
2. WHEN 開発者がdocker-compose upコマンドを実行する THEN システムはコンテナ内でアプリケーションを起動する
3. WHEN コンテナが起動する THEN システムはlocalhost:8501でアプリケーションを提供する
4. WHEN コンテナを停止する THEN システムはローカル環境に何も残さない
5. WHEN 開発者がコンテナ内でコードを編集する THEN システムはボリュームマウントによりローカルの変更を反映する

### 要件3：Dev Containerを使用した開発環境

**ユーザーストーリー**: 開発者として、VS CodeのDev Container機能を使用したい。そうすることで、統合開発環境内で完全に分離された環境で開発できる。

#### 受入基準

1. WHEN 開発者がVS CodeでDev Containerを開く THEN システムは.devcontainer/devcontainer.jsonの設定を読み込む
2. WHEN Dev Containerが起動する THEN システムは必要な拡張機能とパッケージを自動的にインストールする
3. WHEN Dev Container内でコードを編集する THEN システムはリアルタイムで変更を反映する
4. WHEN Dev Containerを削除する THEN システムはローカル環境に影響を与えない

### 要件4：Python環境の準備（仮想環境使用）

**ユーザーストーリー**: 開発者として、Python仮想環境を使用してアプリケーションを実行したい。そうすることで、グローバルなPython環境を汚さずに依存パッケージを管理できる。

#### 受入基準

1. WHEN 開発者がPythonのバージョンを確認するコマンドを実行する THEN システムはPython 3.11のバージョン番号を表示する（本番環境と同じバージョンを推奨）
2. WHEN 開発者がpipのバージョンを確認するコマンドを実行する THEN システムはpipのバージョン番号を表示する
3. WHEN 開発者がvenvモジュールで仮想環境を作成する THEN システムは独立したPython環境を作成する
4. WHEN 仮想環境をアクティベートする THEN システムは仮想環境内のPythonとpipを使用する
5. WHEN 仮想環境内でパッケージをインストールする THEN システムはグローバル環境に影響を与えない

### 要件5：リポジトリの取得

**ユーザーストーリー**: 開発者として、アプリケーションのソースコードをローカル端末に取得したい。そうすることで、コードを編集・実行できるようになる。

#### 受入基準

1. WHEN 開発者がGitリポジトリをクローンする THEN システムは全てのソースファイルとデータファイルをローカルディレクトリに配置する
2. WHEN クローンが完了する THEN システムは必要なディレクトリ構造を保持する
3. WHEN Gitが利用できない環境である THEN システムは代替手段（ZIPダウンロード等）を提供する

### 要件6：依存パッケージのインストール

**ユーザーストーリー**: 開発者として、アプリケーションに必要な依存パッケージをインストールしたい。そうすることで、アプリケーションが正常に動作するようになる。

#### 受入基準

1. WHEN 開発者がrequirements.txtを使用してパッケージをインストールする THEN システムは全ての依存パッケージをインストールする
2. WHEN インストールが完了する THEN システムはstreamlitパッケージとpandasパッケージを利用可能にする
3. WHEN パッケージのインストールに失敗する THEN システムはエラーメッセージと解決方法を表示する
4. WHEN ネットワーク接続に問題がある THEN システムは適切なエラーメッセージを表示する

### 要件7：データファイルの確認

**ユーザーストーリー**: 開発者として、必要なデータファイルが存在することを確認したい。そうすることで、アプリケーションがデータを正しく読み込めることを保証できる。

#### 受入基準

1. WHEN 開発者がdataディレクトリを確認する THEN システムはM_YT_LIVE.TSVファイルを含む
2. WHEN 開発者がdataディレクトリを確認する THEN システムはM_YT_LIVE_TIMESTAMP.TSVファイルを含む
3. WHEN 開発者がdataディレクトリを確認する THEN システムはV_SONG_LIST.TSVファイルを含む
4. WHEN 必要なデータファイルが欠落している THEN システムはエラーメッセージと対処方法を表示する

### 要件8：環境変数の設定（オプション）

**ユーザーストーリー**: 開発者として、ロギング設定などの環境変数を設定したい。そうすることで、開発環境に適した動作をアプリケーションに行わせることができる。

#### 受入基準

1. WHEN 開発者が.env.exampleファイルを確認する THEN システムは設定可能な環境変数の一覧を表示する
2. WHEN 開発者が環境変数を設定する THEN システムは設定値を読み込んでアプリケーションの動作を変更する
3. WHEN 環境変数が設定されていない THEN システムはデフォルト値を使用する
4. WHERE 開発環境である THEN システムはDEBUGレベルのログ出力を許可する

### 要件9：アプリケーションの起動

**ユーザーストーリー**: 開発者として、Streamlitアプリケーションをローカルで起動したい。そうすることで、ブラウザからアプリケーションにアクセスできるようになる。

#### 受入基準

1. WHEN 開発者がstreamlit runコマンドを実行する THEN システムはWebサーバーを起動する
2. WHEN Webサーバーが起動する THEN システムはlocalhost:8501でアプリケーションを提供する
3. WHEN アプリケーションが起動する THEN システムはブラウザを自動的に開く
4. WHEN 起動に失敗する THEN システムはエラーメッセージと原因を表示する
5. WHEN ポート8501が既に使用されている THEN システムは代替ポートを使用するか、エラーメッセージを表示する

### 要件10：動作確認

**ユーザーストーリー**: 開発者として、アプリケーションが正常に動作していることを確認したい。そうすることで、環境構築が成功したことを確認できる。

#### 受入基準

1. WHEN 開発者がブラウザでアプリケーションにアクセスする THEN システムはホームページを表示する
2. WHEN ホームページが表示される THEN システムは検索フォームを表示する
3. WHEN 開発者が検索を実行する THEN システムは検索結果を表示する
4. WHEN 開発者がページ間を移動する THEN システムは各ページを正しく表示する
5. WHEN データ読み込みエラーが発生する THEN システムはユーザーフレンドリーなエラーメッセージを表示する

### 要件11：トラブルシューティング

**ユーザーストーリー**: 開発者として、環境構築中に発生した問題を解決したい。そうすることで、アプリケーションを正常に動作させることができる。

#### 受入基準

1. WHEN Pythonのバージョンが古い THEN システムはPythonのアップグレード方法を提供する
2. WHEN パッケージのインストールに失敗する THEN システムは一般的な原因と解決方法を提供する
3. WHEN データファイルが見つからない THEN システムはファイルパスの確認方法を提供する
4. WHEN ポートが使用中である THEN システムはポート変更方法を提供する
5. WHEN 文字エンコーディングエラーが発生する THEN システムはエンコーディング設定の確認方法を提供する

### 要件12：Windows環境での特別な考慮事項

**ユーザーストーリー**: Windows環境の開発者として、Windows特有の設定や手順を理解したい。そうすることで、スムーズに環境構築を完了できる。

#### 受入基準

1. WHEN Windows環境でPythonをインストールする THEN システムはPATH環境変数への追加方法を提供する
2. WHEN Windows環境でコマンドを実行する THEN システムはコマンドプロンプトまたはPowerShellの使用方法を提供する
3. WHEN Windows環境で環境変数を設定する THEN システムはWindows固有の設定方法を提供する
4. WHEN Windows環境でパス区切り文字が異なる THEN システムは適切なパス表記を使用する

### 要件13：本番環境との整合性

**ユーザーストーリー**: 開発者として、ローカル環境が本番環境（Streamlit Cloud）と同じ動作をすることを確認したい。そうすることで、ローカルでの開発結果が本番環境でも正しく動作することを保証できる。

#### 受入基準

1. WHEN ローカル環境でアプリケーションを実行する THEN システムはStreamlit Cloudと同じバージョンのStreamlitを使用する
2. WHEN ローカル環境でアプリケーションを実行する THEN システムはrequirements.txtに記載された依存パッケージを使用する
3. WHEN データファイルを更新する THEN システムはローカル環境と本番環境の両方で同じデータを使用する
4. WHEN 環境変数を使用する THEN システムはローカル環境と本番環境で適切に設定を切り替える
5. WHEN Pythonのバージョンが異なる THEN システムは互換性の問題を警告する

### 要件14：Dockerfileとdocker-compose.ymlの提供

**ユーザーストーリー**: 開発者として、Dockerを使用した環境構築に必要な設定ファイルを利用したい。そうすることで、簡単にコンテナ環境を構築できる。

#### 受入基準

1. WHEN 開発者がDockerfileを確認する THEN システムはPython 3.11ベースのイメージ定義を含む（本番環境と同じバージョン）
2. WHEN 開発者がdocker-compose.ymlを確認する THEN システムはStreamlitアプリケーションのサービス定義を含む
3. WHEN docker-compose.ymlを使用する THEN システムはボリュームマウントによりコードの変更を反映する
4. WHEN docker-compose.ymlを使用する THEN システムはポート8501をホストにマッピングする
5. WHEN Dockerコンテナを削除する THEN システムはローカル環境のPython環境に影響を与えない


### 要件15：Streamlit Cloudとの連携理解

**ユーザーストーリー**: 開発者として、ローカル開発とStreamlit Cloudへのデプロイの関係を理解したい。そうすることで、効率的な開発フローを確立できる。

#### 受入基準

1. WHEN 開発者がローカルで変更をコミットする THEN システムはGitリポジトリに変更を記録する
2. WHEN Gitリポジトリにプッシュされる THEN Streamlit Cloudは自動的にアプリケーションを再デプロイする
3. WHEN requirements.txtを更新する THEN Streamlit Cloudは新しい依存パッケージを自動的にインストールする
4. WHEN データファイルを更新する THEN Streamlit Cloudは最新のデータを使用する
5. WHEN ローカル環境でのみ使用する設定がある THEN システムは.gitignoreで本番環境への影響を防ぐ

### 要件16：開発ワークフローの確立

**ユーザーストーリー**: 開発者として、ローカル開発から本番デプロイまでのワークフローを理解したい。そうすることで、安全かつ効率的に開発を進めることができる。

#### 受入基準

1. WHEN 開発者が新機能を開発する THEN システムはローカル環境で動作確認を行う
2. WHEN ローカルでの動作確認が完了する THEN システムはdevelopブランチにコミットしてプッシュする
3. WHEN developブランチにプッシュされる THEN Streamlit Cloudはステージング環境（stg-shinoutatime.streamlit.app）を自動的に更新する
4. WHEN ステージング環境での確認が完了する THEN システムはdevelopブランチをmainブランチにマージする
5. WHEN mainブランチにマージされる THEN Streamlit Cloudは本番環境（shinoutatime.streamlit.app）を自動的に更新する
6. WHEN 本番環境でエラーが発生する THEN システムはStreamlit Cloudのログで原因を確認できる
7. WHERE 環境固有の設定が必要である THEN システムは環境変数または設定ファイルで管理する

### 要件17：ブランチ戦略の理解

**ユーザーストーリー**: 開発者として、Gitブランチと環境の対応関係を理解したい。そうすることで、適切なブランチで作業を行うことができる。

#### 受入基準

1. WHEN 開発者がmainブランチを確認する THEN システムは本番環境（shinoutatime.streamlit.app）と同期していることを示す
2. WHEN 開発者がdevelopブランチを確認する THEN システムはステージング環境（stg-shinoutatime.streamlit.app）と同期していることを示す
3. WHEN 開発者が新機能を開発する THEN システムはdevelopブランチから作業ブランチを作成することを推奨する
4. WHEN 開発者がデータファイルを更新する THEN システムはupdate-dataブランチを使用することを推奨する
5. WHEN 作業ブランチの開発が完了する THEN システムはdevelopブランチへのマージを行う
6. WHEN update-dataブランチでのデータ更新が完了する THEN システムはdevelopブランチまたはmainブランチへのマージを行う
7. WHEN ステージング環境でのテストが完了する THEN システムはmainブランチへのマージを行う
