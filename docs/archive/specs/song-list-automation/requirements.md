# 要件定義書

## はじめに

本機能は、「しのうたタイム」プロジェクトにおいて、V_SONG_LIST.TSVの管理運用負荷を削減するための自動化機能です。現在、M_YT_LIVE.TSVとM_YT_LIVE_TIMESTAMP.TSVから手動でExcelを使用してV_SONG_LIST.TSVを生成・更新していますが、この作業を自動化することで、データの一貫性を保ちながら運用効率を向上させます。

## 用語集

- **システム**: V_SONG_LIST.TSV自動生成システム
- **M_YT_LIVE.TSV**: YouTube配信の基本情報を格納するマスターファイル（ID、配信日、タイトル、URL）
- **M_YT_LIVE_TIMESTAMP.TSV**: 各配信内の曲のタイムスタンプ情報を格納するマスターファイル（配信ID、タイムスタンプ、曲名、アーティスト）
- **V_SONG_LIST.TSV**: 曲ごとの最新歌唱情報を格納するビューファイル（アーティスト、アーティスト(ソート用)、曲名、最近の歌唱URL）
- **ソート用アーティスト名**: 日本語の読み仮名をひらがなで表記したアーティスト名（例: "Vaundy" → "Vaundy", "米津玄師" → "よねづけんし"）
- **最新歌唱URL**: 特定の曲が最も最近歌唱された配信のタイムスタンプ付きYouTube URL

## 要件

### 要件1: データ読み込み

**ユーザーストーリー:** データ管理者として、既存のTSVファイルからデータを正確に読み込みたい。これにより、自動化処理の基盤となるデータを確保できる。

#### 受入基準

1. WHEN システムが起動されるとき THEN システムは M_YT_LIVE.TSV ファイルを読み込み、すべての配信情報を取得する
2. WHEN システムが起動されるとき THEN システムは M_YT_LIVE_TIMESTAMP.TSV ファイルを読み込み、すべてのタイムスタンプ情報を取得する
3. WHEN TSVファイルが存在しないとき THEN システムは明確なエラーメッセージを表示し、処理を中断する
4. WHEN TSVファイルの形式が不正なとき THEN システムは該当する行番号とエラー内容を含むエラーメッセージを表示する
5. WHEN TSVファイルの文字エンコーディングがUTF-8でないとき THEN システムは適切にエンコーディングを検出して読み込む

### 要件2: データ結合と集計

**ユーザーストーリー:** データ管理者として、配信情報とタイムスタンプ情報を結合し、曲ごとの最新歌唱情報を自動的に集計したい。これにより、手動でのデータ照合作業を削減できる。

#### 受入基準

1. WHEN システムがデータを処理するとき THEN システムは M_YT_LIVE.TSV と M_YT_LIVE_TIMESTAMP.TSV を配信IDで結合する
2. WHEN 同じ曲名とアーティストの組み合わせが複数存在するとき THEN システムは配信日が最も新しいレコードを最新歌唱として選択する
3. WHEN 配信日が同じ複数のレコードが存在するとき THEN システムは配信ID が大きい方を最新として選択する
4. WHEN タイムスタンプ情報に対応する配信情報が存在しないとき THEN システムは警告メッセージを表示し、該当レコードをスキップする
5. WHEN 曲名またはアーティスト名が空白のレコードが存在するとき THEN システムは該当レコードをスキップし、警告メッセージを表示する
6. WHEN 同じアーティストで曲名に "(1chorus)" や "(short ver)" などのバリエーション表記が含まれる曲と含まれない曲が存在するとき THEN システムはバリエーション表記のない曲を正規の曲名として優先する
7. WHEN 複数のバリエーション表記が存在し正規の曲名が存在しないとき THEN システムは配信日が最も新しいバリエーションを選択する

### 要件3: ソート用アーティスト名の生成

**ユーザーストーリー:** データ管理者として、アーティスト名から自動的にソート用の読み仮名を生成したい。これにより、手動での読み仮名入力作業を削減できる。

#### 受入基準

1. WHEN アーティスト名が英数字のみで構成されるとき THEN システムはアーティスト名をそのままソート用アーティスト名として使用する
2. WHEN アーティスト名に日本語が含まれるとき THEN システムは日本語をひらがなの読み仮名に変換してソート用アーティスト名を生成する
3. WHEN アーティスト名に特殊文字（括弧、記号など）が含まれるとき THEN システムは特殊文字を適切に処理してソート用アーティスト名を生成する
4. WHEN 読み仮名の自動生成が失敗したとき THEN システムは元のアーティスト名をソート用アーティスト名として使用し、警告メッセージを表示する
5. WHEN feat.やCV.などの表記が含まれるとき THEN システムはそれらを含めた形で適切に読み仮名を生成する

### 要件4: 最新歌唱URLの生成

**ユーザーストーリー:** データ管理者として、曲の最新歌唱情報から正確なタイムスタンプ付きYouTube URLを自動生成したい。これにより、ユーザーが直接該当箇所から視聴できるリンクを提供できる。

#### 受入基準

1. WHEN システムが最新歌唱URLを生成するとき THEN システムは配信のベースURLにタイムスタンプパラメータを付加する
2. WHEN タイムスタンプが "HH:MM:SS" 形式のとき THEN システムはこれを秒数に変換してURLパラメータとして使用する
3. WHEN タイムスタンプが "MM:SS" 形式のとき THEN システムはこれを秒数に変換してURLパラメータとして使用する
4. WHEN タイムスタンプが "H:MM:SS" のように時間部分が1桁のとき THEN システムは正しく秒数に変換する
5. WHEN 配信URLにすでにクエリパラメータが含まれているとき THEN システムは既存のパラメータを保持しつつタイムスタンプパラメータを追加する

### 要件5: V_SONG_LIST.TSVの生成

**ユーザーストーリー:** データ管理者として、処理結果を正しい形式でV_SONG_LIST.TSVファイルとして出力したい。これにより、既存のシステムとの互換性を保ちながら自動化の恩恵を受けられる。

#### 受入基準

1. WHEN システムがファイルを出力するとき THEN システムは V_SONG_LIST.TSV をタブ区切り形式で生成する
2. WHEN ファイルを出力するとき THEN システムはヘッダー行として "アーティスト", "アーティスト(ソート用)", "曲名", "最近の歌唱" を含める
3. WHEN ファイルを出力するとき THEN システムはレコードをソート用アーティスト名の昇順でソートする
4. WHEN 同じソート用アーティスト名のレコードが複数存在するとき THEN システムは曲名の昇順でソートする
5. WHEN ファイルの文字エンコーディングを指定するとき THEN システムは UTF-8 エンコーディングでファイルを保存する

### 要件6: コマンドラインインターフェース

**ユーザーストーリー:** データ管理者として、コマンドラインから簡単に自動生成処理を実行したい。これにより、定期的な更新作業やCI/CDパイプラインへの組み込みが容易になる。

#### 受入基準

1. WHEN ユーザーがコマンドを実行するとき THEN システムは標準的なコマンドライン引数を受け付ける
2. WHEN ユーザーが入力ファイルパスを指定するとき THEN システムは指定されたパスからファイルを読み込む
3. WHEN ユーザーが出力ファイルパスを指定するとき THEN システムは指定されたパスにファイルを出力する
4. WHEN ユーザーがヘルプオプションを指定するとき THEN システムは使用方法とオプションの説明を表示する
5. WHEN ユーザーがバージョンオプションを指定するとき THEN システムはバージョン情報を表示する

### 要件7: エラーハンドリングとログ出力

**ユーザーストーリー:** データ管理者として、処理中に発生したエラーや警告を明確に把握したい。これにより、データの品質問題を早期に発見し、対処できる。

#### 受入基準

1. WHEN システムがエラーに遭遇するとき THEN システムは詳細なエラーメッセージを標準エラー出力に表示する
2. WHEN システムが警告を発するとき THEN システムは警告メッセージを標準出力に表示し、処理を継続する
3. WHEN システムが正常に完了するとき THEN システムは処理されたレコード数と出力ファイルパスを表示する
4. WHEN ログレベルを指定するとき THEN システムは指定されたレベル以上のログメッセージのみを出力する
5. WHEN 詳細モードが有効なとき THEN システムは処理の各ステップの詳細情報を出力する

### 要件8: データ整合性の検証

**ユーザーストーリー:** データ管理者として、生成されたV_SONG_LIST.TSVが既存のデータと整合性があることを確認したい。これにより、自動化による予期しないデータ変更を防止できる。

#### 受入基準

1. WHEN 既存のV_SONG_LIST.TSVが存在するとき THEN システムは新旧ファイルの差分を検出して表示する
2. WHEN 新規に追加された曲が存在するとき THEN システムは追加された曲の一覧を表示する
3. WHEN 削除された曲が存在するとき THEN システムは削除された曲の一覧を表示する
4. WHEN 最新歌唱URLが変更された曲が存在するとき THEN システムは変更された曲の一覧を表示する
5. WHEN ドライランモードが有効なとき THEN システムはファイルを実際に書き込まず、変更内容のみを表示する

### 要件9: データ品質チェック

**ユーザーストーリー:** データ管理者として、アーティスト名や曲名の登録ミスを早期に発見したい。これにより、データの品質を維持し、ユーザーに正確な情報を提供できる。

#### 受入基準

1. WHEN 類似したアーティスト名が複数存在するとき THEN システムは類似度が高いアーティスト名のペアを警告として表示する
2. WHEN 類似した曲名が同じアーティストで複数存在するとき THEN システムは類似度が高い曲名のペアを警告として表示する
3. WHEN 類似度の判定を行うとき THEN システムはレーベンシュタイン距離またはそれに準ずるアルゴリズムを使用する
4. WHEN 類似度の閾値を指定するとき THEN システムは指定された閾値以上の類似度を持つペアのみを警告として表示する
5. WHEN 類似性チェックを無効化するオプションが指定されているとき THEN システムは類似性チェックをスキップする
