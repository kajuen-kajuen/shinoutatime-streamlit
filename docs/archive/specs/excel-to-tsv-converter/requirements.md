# 要件定義書

## はじめに

本機能は、Excelファイル（data.xlsx）から2つのTSVファイル（M_YT_LIVE.TSVとM_YT_LIVE_TIMESTAMP.TSV）を自動生成するシステムです。現在、手動で行っているExcelからTSVへの変換作業を自動化し、データ管理の効率化とヒューマンエラーの削減を目指します。

生成された2つのTSVファイルは、既存のsong_list_generatorツールによってV_SONG_LIST.TSVの生成に使用されます。

## 用語集

- **Excel**: Microsoft Excelまたは互換性のあるスプレッドシートファイル形式
- **TSV**: Tab-Separated Values（タブ区切り値）形式のテキストファイル
- **data.xlsx**: 入力元となるExcelファイル
- **M_YT_LIVE.TSV**: YouTube配信情報を格納するTSVファイル（ID、配信日、タイトル、URL）
- **M_YT_LIVE_TIMESTAMP.TSV**: 配信内のタイムスタンプ情報を格納するTSVファイル（ID、LIVE_ID、タイムスタンプ、曲名、アーティスト）
- **V_SONG_LIST.TSV**: 曲リスト情報を格納するTSVファイル（既存のsong_list_generatorで生成）
- **システム**: Excel to TSV変換システム
- **ユーザー**: システムを使用する開発者または管理者
- **変換処理**: Excelファイルを読み込み、TSVファイルを生成する一連の処理

## 要件

### 要件 1

**ユーザーストーリー:** ユーザーとして、data.xlsxファイルを指定して2つのTSVファイルを一括生成したい。これにより、手動変換作業の時間を削減できる。

#### 受入基準

1. WHEN ユーザーがdata.xlsxファイルのパスを指定して変換コマンドを実行する THEN システムは2つのTSVファイル（M_YT_LIVE.TSV、M_YT_LIVE_TIMESTAMP.TSV）を生成する
2. WHEN 変換処理が完了する THEN システムは生成されたファイルの数と保存先パスを表示する
3. WHEN data.xlsxファイルが存在しない THEN システムはエラーメッセージを表示して処理を中断する
4. WHEN 出力先ディレクトリが存在しない THEN システムは自動的にディレクトリを作成する
5. WHEN 既存のTSVファイルが存在する THEN システムはバックアップを作成してから上書きする

### 要件 2

**ユーザーストーリー:** ユーザーとして、Excelの各シートが正しいTSVファイルにマッピングされることを確認したい。これにより、データの整合性を保証できる。

#### 受入基準

1. WHEN Excelファイルに「M_YT_LIVE」という名前のシートが存在する THEN システムはそのシートをM_YT_LIVE.TSVに変換する
2. WHEN Excelファイルに「M_YT_LIVE_TIMESTAMP」という名前のシートが存在する THEN システムはそのシートをM_YT_LIVE_TIMESTAMP.TSVに変換する
3. WHEN 必要なシートが存在しない THEN システムはエラーメッセージを表示して該当シートの変換をスキップする
4. WHEN シート名が大文字小文字で異なる THEN システムは大文字小文字を区別せずにマッピングする
5. WHEN 全ての必要なシートが存在しない THEN システムはエラーメッセージを表示して処理を中断する

### 要件 3

**ユーザーストーリー:** ユーザーとして、TSVファイルが正しいフォーマットで生成されることを確認したい。これにより、既存のシステムとの互換性を維持できる。

#### 受入基準

1. WHEN TSVファイルを生成する THEN システムは各フィールドをタブ文字で区切る
2. WHEN TSVファイルを生成する THEN システムはUTF-8エンコーディングを使用する
3. WHEN セルに改行文字が含まれる THEN システムは改行文字を適切にエスケープまたは削除する
4. WHEN セルにタブ文字が含まれる THEN システムはタブ文字をスペースに置換する
5. WHEN ヘッダー行が存在する THEN システムはヘッダー行を最初の行として出力する

### 要件 4

**ユーザーストーリー:** ユーザーとして、データの妥当性を検証したい。これにより、不正なデータが出力されることを防止できる。

#### 受入基準

1. WHEN M_YT_LIVE.TSVを生成する THEN システムは各行に4つのフィールド（ID、配信日、タイトル、URL）が存在することを検証する
2. WHEN M_YT_LIVE_TIMESTAMP.TSVを生成する THEN システムは各行に5つのフィールド（ID、LIVE_ID、タイムスタンプ、曲名、アーティスト）が存在することを検証する
3. WHEN 必須フィールドが空である THEN システムは警告メッセージを表示する
4. WHEN URLフィールドが有効なURL形式でない THEN システムは警告メッセージを表示する
5. WHEN IDフィールドが数値でない THEN システムはエラーメッセージを表示して該当行をスキップする

### 要件 5

**ユーザーストーリー:** ユーザーとして、変換処理の進捗状況を確認したい。これにより、大量のデータを処理する際の状況を把握できる。

#### 受入基準

1. WHEN 変換処理を開始する THEN システムは処理開始メッセージを表示する
2. WHEN 各シートの変換を開始する THEN システムはシート名と行数を表示する
3. WHEN 各TSVファイルの生成が完了する THEN システムは完了メッセージと出力行数を表示する
4. WHEN エラーが発生する THEN システムはエラーの詳細情報を表示する
5. WHEN 全ての変換処理が完了する THEN システムは処理時間と成功/失敗の統計を表示する

### 要件 6

**ユーザーストーリー:** ユーザーとして、コマンドラインから簡単に実行できるインターフェースが欲しい。これにより、自動化スクリプトに組み込むことができる。

#### 受入基準

1. WHEN ユーザーがコマンドライン引数なしで実行する THEN システムはデフォルトのdata.xlsxファイルを使用する
2. WHEN ユーザーが入力ファイルパスを指定する THEN システムは指定されたファイルを使用する
3. WHEN ユーザーが出力ディレクトリを指定する THEN システムは指定されたディレクトリにTSVファイルを生成する
4. WHEN ユーザーが--helpオプションを指定する THEN システムは使用方法を表示する
5. WHEN ユーザーが--dry-runオプションを指定する THEN システムは実際のファイル生成を行わずに処理内容を表示する

### 要件 7

**ユーザーストーリー:** ユーザーとして、既存のTSVファイルを安全にバックアップしたい。これにより、データの損失を防止できる。

#### 受入基準

1. WHEN 既存のTSVファイルが存在する THEN システムはタイムスタンプ付きのバックアップファイルを作成する
2. WHEN バックアップファイルを作成する THEN システムはファイル名に日時情報（YYYYMMDD_HHMMSS）を付加する
3. WHEN バックアップディレクトリが存在しない THEN システムは自動的にdata/backupsディレクトリを作成する
4. WHEN バックアップの作成に失敗する THEN システムはエラーメッセージを表示して変換処理を中断する
5. WHEN バックアップが正常に作成される THEN システムはバックアップファイルのパスを表示する

### 要件 8

**ユーザーストーリー:** ユーザーとして、Excelファイルの読み込みエラーに対して適切に対処したい。これにより、システムの堅牢性を確保できる。

#### 受入基準

1. WHEN Excelファイルが破損している THEN システムはエラーメッセージを表示して処理を中断する
2. WHEN Excelファイルが他のプロセスで開かれている THEN システムはエラーメッセージを表示して処理を中断する
3. WHEN Excelファイルの読み込み権限がない THEN システムはエラーメッセージを表示して処理を中断する
4. WHEN Excelファイルの形式が不正である THEN システムはエラーメッセージを表示して処理を中断する
5. WHEN シートが空である THEN システムは警告メッセージを表示して該当シートの変換をスキップする

### 要件 9

**ユーザーストーリー:** ユーザーとして、TSVファイル生成後に自動的にV_SONG_LIST.TSVを生成したい。これにより、一連のデータ更新作業を一度に完了できる。

#### 受入基準

1. WHEN M_YT_LIVE.TSVとM_YT_LIVE_TIMESTAMP.TSVの生成が成功する THEN システムは自動的にsong_list_generatorを実行する
2. WHEN song_list_generatorを実行する THEN システムは生成されたTSVファイルのパスを引数として渡す
3. WHEN song_list_generatorの実行が成功する THEN システムはV_SONG_LIST.TSVが生成されたことを表示する
4. WHEN song_list_generatorの実行が失敗する THEN システムはエラーメッセージを表示するが、M_YT_LIVE.TSVとM_YT_LIVE_TIMESTAMP.TSVは保持する
5. WHEN ユーザーが--skip-song-listオプションを指定する THEN システムはsong_list_generatorの実行をスキップする
