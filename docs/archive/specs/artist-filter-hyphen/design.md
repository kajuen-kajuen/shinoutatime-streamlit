# 設計書

## 概要

本設計書は、V_SONG_LIST.TSVファイルから読み込まれた楽曲データにおいて、アーティスト名が「-」（ハイフン）である楽曲を表示から除外するフィルタリング機能の設計を定義します。この機能は、Song List betaページ（pages/99_Song_List_beta.py）に実装され、ユーザーに対してより意味のある楽曲リストを提供します。

## アーキテクチャ

### システム構成

本機能は、既存のStreamlitアプリケーションのデータ処理フローに統合されます。

```
[V_SONG_LIST.TSV] 
    ↓
[DataService.load_song_list_data()] ← データ読み込み
    ↓
[DataFrame] ← 生データ
    ↓
[フィルタリング処理] ← **新規追加**
    ↓
[DataFrame] ← フィルタリング済みデータ
    ↓
[ソート処理] ← 既存処理
    ↓
[HTMLテーブル生成] ← 既存処理
    ↓
[Streamlit表示]
```

### 設計原則

1. **最小限の変更**: 既存のコードへの影響を最小限に抑える
2. **データの不変性**: 元のTSVファイルは変更しない
3. **処理の透明性**: フィルタリング処理を明示的に記述する
4. **パフォーマンス**: Pandasの効率的な操作を使用する

## コンポーネントとインターフェース

### 1. フィルタリング関数

新しいフィルタリング処理は、pages/99_Song_List_beta.py内に実装されます。

```python
def filter_hyphen_artists(df: pd.DataFrame) -> pd.DataFrame:
    """
    アーティスト名が「-」の楽曲を除外する
    
    Args:
        df: 楽曲データを含むDataFrame
        
    Returns:
        フィルタリング済みのDataFrame
    """
    pass
```

### 2. 既存コンポーネントとの統合

- **DataService**: 変更なし。既存のload_song_list_data()メソッドをそのまま使用
- **ソート処理**: 変更なし。フィルタリング後のデータに対して既存のソート処理を適用
- **HTMLテーブル生成**: 変更なし。既存の表示ロジックをそのまま使用

## データモデル

### 入力データ

V_SONG_LIST.TSVファイルの構造:

| 列名 | データ型 | 説明 |
|------|---------|------|
| アーティスト | str | アーティスト名（表示用） |
| アーティスト(ソート用) | str | アーティスト名（ソート用） |
| 曲名 | str | 楽曲名 |
| 最近の歌唱 | str | YouTube URL |

### フィルタリング条件

- **除外条件**: `アーティスト == "-"`
- **保持条件**: `アーティスト != "-"`

### 出力データ

フィルタリング後のDataFrameは、入力と同じ構造を持ちますが、アーティスト名が「-」の行が除外されています。

## 正確性プロパティ

*プロパティとは、システムのすべての有効な実行において真であるべき特性または動作のことです。プロパティは、人間が読める仕様と機械で検証可能な正確性保証との橋渡しとなります。*

### プロパティ 1: ハイフンアーティストの除外

*任意の* 楽曲データを含むDataFrameに対して、フィルタリング処理を適用した後、アーティスト名が「-」である行は存在してはならない

**検証要件: 1.1**

### プロパティ 2: 非ハイフンアーティストの保持

*任意の* 楽曲データを含むDataFrameに対して、フィルタリング処理を適用した後、アーティスト名が「-」以外である行はすべて保持されなければならない

**検証要件: 1.5**

### プロパティ 3: フィルタリング後の件数の正確性

*任意の* 楽曲データを含むDataFrameに対して、フィルタリング処理を適用した後、結果のDataFrameの行数は、元のDataFrameからアーティスト名が「-」である行を除いた行数と等しくなければならない

**検証要件: 1.4**

## エラーハンドリング

### エッジケース

1. **空のDataFrame**: 
   - 入力が空のDataFrameの場合、フィルタリング処理は空のDataFrameを返す
   - エラーを発生させない

2. **すべての行がハイフン**:
   - すべての行のアーティスト名が「-」の場合、フィルタリング処理は空のDataFrameを返す
   - エラーを発生させない

3. **ハイフンが存在しない**:
   - アーティスト名が「-」の行が存在しない場合、フィルタリング処理は元のDataFrameと同じ内容を返す

4. **アーティスト列が存在しない**:
   - 「アーティスト」列が存在しない場合、適切なエラーメッセージを表示する
   - システムは安全に処理を中断する

### エラーメッセージ

フィルタリング処理中にエラーが発生した場合、以下のようなメッセージを表示します:

```
エラー: 楽曲データの処理中に問題が発生しました。
データファイルの形式を確認してください。
```

## テスト戦略

### ユニットテスト

フィルタリング関数の基本的な動作を検証します:

1. **正常系テスト**:
   - アーティスト名が「-」の行が除外されることを確認
   - アーティスト名が「-」以外の行が保持されることを確認
   - フィルタリング後の件数が正確であることを確認

2. **エッジケーステスト**:
   - 空のDataFrameに対する処理
   - すべての行がハイフンの場合
   - ハイフンが存在しない場合
   - アーティスト列が存在しない場合

### プロパティベーステスト

Hypothesisライブラリを使用して、プロパティベーステストを実装します:

1. **プロパティ 1のテスト**:
   - ランダムな楽曲データを生成
   - フィルタリング処理を適用
   - 結果にアーティスト名が「-」の行が存在しないことを確認

2. **プロパティ 2のテスト**:
   - ランダムな楽曲データを生成
   - フィルタリング処理を適用
   - 元のDataFrameで「-」以外のアーティスト名を持つ行がすべて保持されていることを確認

3. **プロパティ 3のテスト**:
   - ランダムな楽曲データを生成
   - フィルタリング処理を適用
   - 結果の行数が期待値と一致することを確認

各プロパティベーステストは、最低100回の反復を実行します。

### テストデータ生成戦略

Hypothesisのストラテジーを使用して、以下のようなテストデータを生成します:

```python
from hypothesis import strategies as st

# アーティスト名の生成（「-」を含む）
artist_strategy = st.one_of(
    st.just("-"),  # ハイフン
    st.text(min_size=1, max_size=50).filter(lambda x: x != "-")  # 通常のアーティスト名
)

# 楽曲データの生成
song_data_strategy = st.lists(
    st.fixed_dictionaries({
        "アーティスト": artist_strategy,
        "アーティスト(ソート用)": artist_strategy,
        "曲名": st.text(min_size=1, max_size=100),
        "最近の歌唱": st.text(min_size=1, max_size=200)
    }),
    min_size=0,
    max_size=100
)
```

## 実装の詳細

### フィルタリング処理の実装場所

pages/99_Song_List_beta.pyの以下の位置にフィルタリング処理を追加します:

```python
# データの読み込み
df_original = load_song_list()

if df_original is not None:
    # ★★★ フィルタリング処理を追加 ★★★
    df_filtered = df_original[df_original["アーティスト"] != "-"].copy()
    
    # ソート処理（既存）
    df_sorted = df_filtered.sort_values(...)
    
    # 以降の処理は既存のまま
```

### パフォーマンスへの影響

- フィルタリング処理は、Pandasのベクトル化された操作を使用するため、高速です
- データサイズが数千行程度であれば、パフォーマンスへの影響はほぼありません
- キャッシュ機能（@st.cache_data）により、再読み込みは発生しません

## 実装の制約

1. **Pandasのバージョン**: pandas >= 1.0.0
2. **Python のバージョン**: Python >= 3.8
3. **既存コードへの影響**: 最小限（数行の追加のみ）
4. **後方互換性**: 既存の機能に影響なし

