# 設計書

## 概要

「しのうたタイム」は、VTuber「幽音しの」さんの配信で歌唱された楽曲を検索・閲覧できる非公式ファンサイトです。Streamlitフレームワークを使用したPython製Webアプリケーションとして実装されています。

本アプリケーションは、TSVファイルからデータを読み込み、ユーザーに対して検索可能な楽曲データベースを提供します。主な機能として、キーワード検索、段階的表示、YouTubeタイムスタンプ付きリンク生成、楽曲リスト表示、情報ページ表示などがあります。

## アーキテクチャ

### システム構成

```
しのうたタイムアプリケーション
├── フロントエンド層（Streamlit UI）
│   ├── Home.py（メインページ・検索機能）
│   ├── pages/01_Information.py（情報ページ）
│   ├── pages/02_About_Us.py（About Usページ）
│   └── pages/99_Song_List_beta.py（楽曲リストページ）
├── ビジネスロジック層
│   ├── データ読み込み処理
│   ├── データ結合処理
│   ├── 検索フィルタリング処理
│   ├── ソート処理
│   ├── URL生成処理
│   └── 曲目番号生成処理
├── データ層
│   ├── data/M_YT_LIVE.TSV（配信データ）
│   ├── data/M_YT_LIVE_TIMESTAMP.TSV（楽曲タイムスタンプデータ）
│   ├── data/V_SONG_LIST.TSV（楽曲リストデータ）
│   ├── data/tweet_embed_code.html（Twitter埋め込みコード）
│   └── data/tweet_height.txt（Twitter埋め込み高さ設定）
└── 共通モジュール層
    ├── footer.py（フッター表示モジュール）
    └── style.css（カスタムCSSスタイル）
```

### 技術スタック

- **フレームワーク**: Streamlit
- **プログラミング言語**: Python 3.x
- **データ処理**: Pandas
- **画像処理**: Pillow (PIL)
- **データ形式**: TSV (Tab-Separated Values)
- **スタイリング**: CSS

### デプロイメント

アプリケーションは以下のコマンドで起動します：
```bash
streamlit run Home.py
```

## コンポーネントとインターフェース

### 1. Home.py（メインページ）

#### 責務
- アプリケーションのエントリーポイント
- 楽曲検索機能の提供
- 検索結果の表示
- 段階的表示機能の実装

#### 主要機能

##### 1.1 データ読み込み
```python
# 配信データの読み込み
df_lives = pd.read_csv("data/M_YT_LIVE.TSV", delimiter="\t")

# 楽曲データの読み込み
df_songs = pd.read_csv("data/M_YT_LIVE_TIMESTAMP.TSV", delimiter="\t")
```

##### 1.2 データ結合
- `LIVE_ID`をキーとして配信データと楽曲データを結合
- 左結合（left join）を使用し、楽曲データを基準とする

##### 1.3 タイムスタンプ変換
```python
def convert_timestamp_to_seconds(timestamp_str):
    """
    タイムスタンプ文字列（HH:MM:SS または MM:SS）を秒数に変換
    
    Args:
        timestamp_str: タイムスタンプ文字列
        
    Returns:
        int: 秒数、変換失敗時はNone
    """
```

##### 1.4 曲目番号生成
- 各配信内で楽曲に連番を振る
- 同一日に複数配信がある場合は「配信番号-曲順」形式
- 同一日に1配信のみの場合は「曲順」形式

##### 1.5 検索機能
- キーワード入力欄
- 検索ボタン
- ライブタイトル検索オプション（チェックボックス）
- 部分一致検索（大文字小文字を区別しない）

##### 1.6 段階的表示
- 初期表示: 25件
- 「さらに25件表示」ボタンで25件ずつ追加
- 現在の表示件数と総件数の表示

#### セッション状態管理
```python
st.session_state.df_full          # 全データ
st.session_state.filtered_df      # フィルタリング後のデータ
st.session_state.search_query     # 検索クエリ
st.session_state.include_live_title  # ライブタイトル検索フラグ
st.session_state.display_limit    # 表示件数制限
```

### 2. pages/01_Information.py（情報ページ）

#### 責務
- 配信スケジュールの表示
- お知らせ情報の表示
- Twitter投稿の埋め込み表示

#### 主要機能

##### 2.1 YouTube動画埋め込み
```python
st.video("https://www.youtube.com/watch?v=...")
```

##### 2.2 Twitter投稿埋め込み
```python
def display_embedded_tweet(embed_code_path, height_path, default_height=850):
    """
    Twitter埋め込みコードを読み込んで表示
    
    Args:
        embed_code_path: 埋め込みコードファイルのパス
        height_path: 高さ設定ファイルのパス
        default_height: デフォルトの高さ
    """
```

##### 2.3 過去のお知らせ表示
- `st.expander`を使用した展開可能なセクション
- 日付とグッズ情報を見出しに統合
- Twitter埋め込みコードを直接記述

### 3. pages/02_About_Us.py（About Usページ）

#### 責務
- サイトの目的説明
- 注意事項の表示
- スペシャルサンクスの表示

#### 主要機能
- Markdownによる静的コンテンツの表示
- 外部リンクの提供

### 4. pages/99_Song_List_beta.py（楽曲リストページ）

#### 責務
- 全楽曲リストの表示
- アーティスト順のソート
- β版の制約説明

#### 主要機能

##### 4.1 データ読み込み（キャッシュ付き）
```python
@st.cache_data
def load_data(path):
    """
    TSVファイルを読み込んでDataFrameを返す
    Streamlitのキャッシュ機能により、再読み込みを防ぐ
    """
```

##### 4.2 アーティスト順ソート
- `アーティスト(ソート用)`列を使用
- 大文字小文字を区別しない
- 安定ソート（mergesort）により同一アーティスト内の曲順を維持

##### 4.3 インラインCSS
- ページ固有のCSSスタイルをPythonコード内に直接記述
- `st.markdown`でCSSを適用

### 5. footer.py（フッターモジュール）

#### 責務
- 全ページで共通のフッター表示

#### インターフェース
```python
def display_footer():
    """
    Streamlitアプリケーションのフッターを表示する関数
    
    表示内容:
    - 区切り線
    - クレジット表示
    - 連絡先情報
    """
```

### 6. style.css（カスタムスタイル）

#### 責務
- アプリケーション全体のスタイリング
- レイアウト調整
- テーブルのスタイリング

#### 主要スタイル定義

##### 6.1 レイアウト
```css
.block-container {
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
}
```

##### 6.2 テーブルスタイル
```css
table.dataframe th,
table.dataframe td {
    white-space: nowrap;  /* 改行防止 */
}

.artist-cell {
    white-space: normal;  /* アーティスト列のみ改行許可 */
    word-break: break-word;
}
```

## データモデル

### 配信データ（M_YT_LIVE.TSV）

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| ID | 整数 | 配信の一意識別子 |
| 配信日 | 文字列/数値 | 配信日（UNIXミリ秒またはYYYY/MM/DD形式） |
| タイトル | 文字列 | 配信タイトル |
| URL | 文字列 | YouTube配信URL |

### 楽曲タイムスタンプデータ（M_YT_LIVE_TIMESTAMP.TSV）

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| ID | 整数 | 楽曲レコードの一意識別子 |
| LIVE_ID | 整数 | 配信IDへの外部キー |
| 曲名 | 文字列 | 楽曲名 |
| アーティスト | 文字列 | アーティスト名 |
| タイムスタンプ | 文字列 | 歌唱開始時刻（HH:MM:SSまたはMM:SS形式） |

### 楽曲リストデータ（V_SONG_LIST.TSV）

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| アーティスト | 文字列 | アーティスト名（表示用） |
| アーティスト(ソート用) | 文字列 | アーティスト名（ソート用） |
| 曲名 | 文字列 | 楽曲名 |
| 最近の歌唱 | 文字列 | 最近の歌唱へのYouTube URL |

### 結合後のデータモデル

データ結合後、以下の派生カラムが追加されます：

| カラム名 | データ型 | 説明 |
|---------|---------|------|
| 楽曲ID | 整数 | 元のID_song |
| ライブ配信日 | 文字列 | 表示用の配信日 |
| ライブ配信日_sortable | datetime | ソート用の配信日 |
| ライブタイトル | 文字列 | 配信タイトル |
| 元ライブURL | 文字列 | 配信URL |
| タイムスタンプ_秒 | 整数 | タイムスタンプの秒数 |
| YouTubeタイムスタンプ付きURL | 文字列 | タイムスタンプ付きYouTube URL |
| 曲順 | 整数 | 配信内での歌唱順序 |
| ライブ番号 | 整数 | 同一日内の配信番号 |
| 曲目 | 文字列 | 表示用の曲目番号 |
| YouTubeリンク | 文字列 | HTMLリンクタグ |

## エラーハンドリング

### ファイル読み込みエラー

#### TSVファイルが存在しない場合
```python
try:
    df = pd.read_csv(file_path, delimiter="\t")
except FileNotFoundError:
    st.error(f'エラー: ファイル "{file_path}" が見つかりません。')
    st.info(f"`{file_path}` が正しく配置されているか確認してください。")
```

#### ファイル読み込み中のエラー
```python
except Exception as e:
    st.error(f'ファイル "{file_path}" の読み込み中にエラー: {e}')
```

### CSSファイル読み込みエラー

```python
try:
    with open("style.css", encoding="utf-8") as f:
        st.markdown(f"<style>{f.read()}</style>", unsafe_allow_html=True)
except FileNotFoundError:
    st.error("エラー: style.css が見つかりません。")
    st.info("`style.css` がアプリと同じディレクトリにあるか確認してください。")
except Exception as e:
    st.error(f"エラー: style.css の読み込み中に問題が発生しました: {e}")
```

### データ変換エラー

#### 日付変換エラー
```python
try:
    df_merged.loc[mask_nat_sortable, "ライブ配信日_sortable"] = pd.to_datetime(
        df_merged.loc[mask_nat_sortable, "ライブ配信日_original"],
        errors="coerce",
    )
except Exception as e:
    st.warning(f"ソート用の「ライブ配信日」変換中にエラーが発生しました: {e}")
```

### Twitter埋め込みエラー

```python
try:
    with open(embed_code_path, "r", encoding="utf-8") as f:
        tweet_embed_code = f.read()
except FileNotFoundError:
    st.info(f"情報: 表示するコンテンツがありません。（{os.path.basename(embed_code_path)}）")
    return
```

## テスト戦略

### 単体テスト

#### 1. データ読み込み機能のテスト
- 正常なTSVファイルの読み込み
- 存在しないファイルのエラーハンドリング
- 不正な形式のファイルのエラーハンドリング

#### 2. タイムスタンプ変換機能のテスト
- HH:MM:SS形式の変換
- MM:SS形式の変換
- 不正な形式の処理
- None値の処理

#### 3. 検索フィルタリング機能のテスト
- 曲名での部分一致検索
- アーティスト名での部分一致検索
- ライブタイトルでの検索
- 大文字小文字を区別しない検索
- 空の検索クエリの処理

#### 4. URL生成機能のテスト
- 正常なタイムスタンプ付きURL生成
- タイムスタンプがNoneの場合の処理
- URLがNoneの場合の処理

#### 5. 曲目番号生成機能のテスト
- 単一配信の曲目番号生成
- 複数配信の曲目番号生成
- 配信番号の正確性

### 統合テスト

#### 1. データフロー全体のテスト
- データ読み込み → 結合 → ソート → 表示の一連の流れ
- 検索 → フィルタリング → 表示の流れ

#### 2. ページ遷移のテスト
- 各ページが正常に表示されること
- フッターが全ページで表示されること

### UIテスト

#### 1. レスポンシブデザインのテスト
- デスクトップ表示
- タブレット表示
- モバイル表示

#### 2. インタラクションのテスト
- 検索ボタンのクリック
- チェックボックスの切り替え
- 「さらに25件表示」ボタンのクリック
- YouTubeリンクのクリック

### パフォーマンステスト

#### 1. データ読み込み速度
- 大量データの読み込み時間
- キャッシュの効果確認

#### 2. 検索速度
- 大量データでの検索速度
- フィルタリング処理の速度

#### 3. 表示速度
- 初期表示速度
- 段階的表示の追加速度

### エラーハンドリングのテスト

#### 1. ファイル不在時の動作
- 各TSVファイルが存在しない場合
- CSSファイルが存在しない場合
- Twitter埋め込みファイルが存在しない場合

#### 2. データ不整合時の動作
- 不正な日付形式
- 不正なタイムスタンプ形式
- 欠損値の処理

## セキュリティ考慮事項

### 1. XSS（クロスサイトスクリプティング）対策
- HTMLリンク生成時は信頼できるデータソースのみを使用
- ユーザー入力は検索クエリのみで、Pandasのフィルタリング機能を使用
- `unsafe_allow_html=True`の使用は必要最小限に限定

### 2. データの完全性
- TSVファイルは信頼できるソースから提供
- ファイルの改ざん検知は実装していないが、手動管理により担保

### 3. 外部リンク
- YouTube URLは信頼できるドメイン（youtube.com）のみ
- Twitter埋め込みは公式のembedコードを使用

## パフォーマンス最適化

### 1. データキャッシング
```python
@st.cache_data
def load_data(path):
    # データ読み込み処理
```
- Streamlitのキャッシュ機能により、再読み込みを防ぐ
- ファイルが変更されない限り、キャッシュされたデータを使用

### 2. 段階的表示
- 初期表示を25件に制限
- ユーザーの要求に応じて25件ずつ追加
- 大量データでも初期表示速度を維持

### 3. セッション状態の活用
- フィルタリング結果をセッション状態に保存
- 不要な再計算を防ぐ

### 4. 効率的なデータ処理
- Pandasの最適化された操作を使用
- 不要な列は早期に削除
- ソートは一度だけ実行

## 今後の拡張性

### 1. データベース化
現在はTSVファイルを使用していますが、将来的にはSQLiteやPostgreSQLなどのデータベースへの移行を検討できます。

### 2. 検索機能の強化
- 正規表現検索
- 複数キーワード検索（AND/OR条件）
- 日付範囲検索
- タグ検索

### 3. ユーザー機能
- お気に入り機能
- プレイリスト作成
- 視聴履歴

### 4. 管理機能
- データ追加・編集のWebインターフェース
- 自動データ取得（YouTube API連携）
- データバックアップ機能

### 5. 分析機能
- 歌唱頻度の統計
- アーティスト別の集計
- 時系列分析

## 制約事項

### 1. β版の制約
- アーティスト・楽曲の並び順が完全ではない（漢字のソート）
- 一部楽曲の重複表示
- 機能の予告なき変更の可能性

### 2. データの正確性
- 手作業によるデータ入力のため、誤りの可能性
- 最新情報の反映遅延

### 3. 非公式サイト
- 公式情報との相違の可能性
- 本人・事務所との無関係

### 4. 技術的制約
- Streamlitの制約に依存
- サーバーサイドレンダリングのみ（クライアントサイドJavaScriptは限定的）
