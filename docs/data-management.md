# データ管理ガイド

## 概要

本ドキュメントは、「しのうたタイム」アプリケーションで使用するデータファイルの管理方法を説明します。データは全てTSV（タブ区切り）形式で保存されており、手動での更新・追加が可能です。

## データファイル構成

アプリケーションは以下のデータファイルを使用します：

```
data/
├── data.xlsx                   # 入力用Excelファイル（管理者向け）
├── M_YT_LIVE.TSV               # 配信データ
├── M_YT_LIVE_TIMESTAMP.TSV     # 楽曲タイムスタンプデータ
├── V_SONG_LIST.TSV             # 楽曲リストデータ
├── ARTIST_SORT_MAPPING.TSV     # アーティスト名ソート修正マッピング
├── tweet_embed_code.html       # Twitter埋め込みコード
├── tweet_height.txt            # Twitter埋め込み高さ設定
└── backups/                    # バックアップディレクトリ
    ├── M_YT_LIVE_*.TSV         # 配信データのバックアップ
    ├── M_YT_LIVE_TIMESTAMP_*.TSV # タイムスタンプデータのバックアップ
    └── tweet_embed_code_*.html # Twitter埋め込みコードのバックアップ
```

## データフォーマット仕様

### 1. M_YT_LIVE.TSV（配信データ）

配信情報を管理するマスターファイルです。

#### フォーマット

```
ID	配信日	タイトル	URL
```

#### カラム仕様

| カラム名 | データ型 | 必須 | 説明 | 例 |
|---------|---------|------|------|-----|
| ID | 整数 | ✓ | 配信の一意識別子（連番） | 1 |
| 配信日 | 文字列 | ✓ | 配信日（YYYY/M/D形式） | 2025/4/27 |
| タイトル | 文字列 | ✓ | 配信タイトル | 【初配信】おばけじゃないから、怖くないよ〜 |
| URL | 文字列 | ✓ | YouTube配信URL | https://www.youtube.com/live/... |

#### 注意事項

- **ID**: 必ず一意の値を設定してください。既存の最大ID + 1を使用することを推奨します
- **配信日**: 年は4桁、月日は1桁または2桁で記述します（例: 2025/4/27、2025/12/31）
- **タイトル**: 配信タイトルをそのまま記述します。特殊文字も使用可能です
- **URL**: YouTube配信のURLを完全な形式で記述します（`https://www.youtube.com/live/...`）

#### 記述例

```tsv
ID	配信日	タイトル	URL
1	2025/4/27	【初配信】おばけじゃないから、怖くないよ〜.。o○【幽音しの:ななしいんく】	https://www.youtube.com/live/rPoEadXC5ck?si=PyjsfpuwHgwH2fjV
2	2025/4/28	【雑談】今日こそはアップのしのを見せます！！【幽音しの:ななしいんく】	https://www.youtube.com/live/ManpEHIFXt8?si=FaF-JgKp6sZN0EAV
```

### 2. M_YT_LIVE_TIMESTAMP.TSV（楽曲タイムスタンプデータ）

配信内で歌唱された楽曲の情報を管理するファイルです。

#### フォーマット

```
ID	LIVE_ID	タイムスタンプ	曲名	アーティスト
```

#### カラム仕様

| カラム名 | データ型 | 必須 | 説明 | 例 |
|---------|---------|------|------|-----|
| ID | 整数 | ✓ | 楽曲レコードの一意識別子（連番） | 1 |
| LIVE_ID | 整数 | ✓ | 配信IDへの外部キー（M_YT_LIVE.TSVのIDと対応） | 1 |
| タイムスタンプ | 文字列 | ✓ | 歌唱開始時刻（H:MM:SS または MM:SS形式） | 0:01:47 |
| 曲名 | 文字列 | ✓ | 楽曲名 | かすかなおと |
| アーティスト | 文字列 | ✓ | アーティスト名 | 幽音しの |

#### 注意事項

- **ID**: 必ず一意の値を設定してください。既存の最大ID + 1を使用することを推奨します
- **LIVE_ID**: M_YT_LIVE.TSVに存在するIDを指定してください。存在しないIDを指定すると、その楽曲は表示されません
- **タイムスタンプ**: 
  - 1時間未満の場合: `MM:SS`形式（例: `1:47`、`23:01`）
  - 1時間以上の場合: `H:MM:SS`形式（例: `1:03:13`、`2:45:18`）
  - 時間の桁は1桁でも2桁でも可（例: `1:03:13`と`01:03:13`は同じ）
- **曲名**: 正確な楽曲名を記述してください
- **アーティスト**: 
  - ボカロ曲の場合: `作曲者 feat.ボーカロイド名`の形式を推奨（例: `ryo(supercell) feat.初音ミク`）
  - カバー曲の場合: 原曲のアーティスト名を記述
  - 即興曲の場合: `幽音しの(即興)`と記述

#### 記述例

```tsv
ID	LIVE_ID	タイムスタンプ	曲名	アーティスト
1	1	0:01:47	かすかなおと	幽音しの
2	1	0:03:13	怪獣の花唄	Vaundy
3	1	0:26:45	初配信兼入浴の歌	幽音しの(即興)
```

### 3. V_SONG_LIST.TSV（楽曲リストデータ）

全楽曲のリスト表示用データを管理するファイルです。

#### フォーマット

```
アーティスト	アーティスト(ソート用)	曲名	最近の歌唱
```

#### カラム仕様

| カラム名 | データ型 | 必須 | 説明 | 例 |
|---------|---------|------|------|-----|
| アーティスト | 文字列 | ✓ | 表示用アーティスト名 | Orangestar feat.IA |
| アーティスト(ソート用) | 文字列 | ✓ | ソート用アーティスト名（ひらがな・英字） | Orangestar feat.IA |
| 曲名 | 文字列 | ✓ | 楽曲名 | Alice in 冷凍庫 |
| 最近の歌唱 | 文字列 | ✓ | 最近の歌唱へのYouTubeタイムスタンプ付きURL | https://www.youtube.com/live/...&t=XXXs |

#### 注意事項

- **アーティスト**: 表示用の正式なアーティスト名を記述します
- **アーティスト(ソート用)**: 
  - 日本語の場合: ひらがなで読み仮名を記述（例: `ヨルシカ` → `よるしか`）
  - 英語の場合: そのまま記述（例: `YOASOBI` → `YOASOBI`）
  - 記号は除外（例: `μ's(ラブライブ!)` → `μ's(らぶらいぶ!)`）
  - 大文字小文字は区別されません
- **曲名**: M_YT_LIVE_TIMESTAMP.TSVと同じ曲名を使用してください
- **最近の歌唱**: 
  - YouTubeのタイムスタンプ付きURLを記述
  - フォーマット: `https://www.youtube.com/live/{VIDEO_ID}?si={SHARE_ID}&t={SECONDS}s`
  - `{SECONDS}`は秒数（例: 1分47秒 = 107秒）

#### 記述例

```tsv
アーティスト	アーティスト(ソート用)	曲名	最近の歌唱
Orangestar feat.IA	Orangestar feat.IA	Alice in 冷凍庫	https://www.youtube.com/live/Dm-WC5w7K8Y?si=Pph-3uJ8wVrF5vc0&t=5406s
ヨルシカ	よるしか	花に亡霊	https://www.youtube.com/live/nyXzxG79mwQ?si=kGuFyOuc0o-yNPOU&t=1867s
```

### 4. tweet_embed_code.html（Twitter埋め込みコード）

情報ページに表示するTwitter投稿の埋め込みコードを保存するファイルです。

#### フォーマット

HTMLファイル形式で、Twitter（X）の埋め込みコードをそのまま保存します。

#### 取得方法

1. Twitter（X）で埋め込みたい投稿を開く
2. 投稿の右上の「...」メニューから「埋め込む」を選択
3. 表示されたHTMLコードをコピー
4. `data/tweet_embed_code.html`に保存

#### 注意事項

- ファイルが存在しない場合、情報ページに「情報: 表示するコンテンツがありません。」と表示されます
- 複数の投稿を表示したい場合は、埋め込みコードを連結して保存してください

### 5. tweet_height.txt（Twitter埋め込み高さ設定）

Twitter埋め込みの表示高さを設定するファイルです。

#### フォーマット

```
850
```

#### 注意事項

- 数値のみを記述してください（単位不要）
- デフォルト値: 850（ピクセル）
- ファイルが存在しない場合、デフォルト値が使用されます

## データ更新手順

### Excelファイルからのデータ更新 (推奨)

`data/data.xlsx`を更新した後、以下の統合スクリプトを実行することで、関連するTSVファイルを自動的に生成・更新できます。

1.  `data/data.xlsx` を最新の情報に更新します。
2.  以下のコマンドを実行します。
    ```bash
    scripts/excel_to_tsv.bat full
    ```
    - このコマンドは、`M_YT_LIVE.TSV`、`M_YT_LIVE_TIMESTAMP.TSV`、`V_SONG_LIST.TSV`を生成・更新します。
    - 各TSVファイルは更新前に自動的にバックアップされます。
    - 詳細は [Excel to TSV変換ガイド](../guides/excel-to-tsv-guide.md) を参照してください。

### Twitter埋め込みコードの更新

Twitterの埋め込みコードは、以下のCLIツールまたはStreamlit管理画面から更新できます。

#### コマンドラインインターフェース (CLI)
```bash
docker-compose exec shinouta-time python -m src.cli.twitter_embed_cli [ツイートURL...]
```
- 詳細は [Twitter埋め込みコード自動取得システム](../twitter-embed-automation.md) を参照してください。

#### Streamlit管理画面 (UI)
1. Streamlitアプリケーションを起動し、サイドバーから「Twitter Embed Admin」ページにアクセスします。
2. 管理者パスワードを入力してログインし、ツイートURLを入力して更新します。
- 詳細は [Twitter埋め込みコード管理画面 使用ガイド](../twitter-embed-admin-guide.md) を参照してください。

### タイムスタンプ付きURLの作成方法

YouTubeのタイムスタンプ付きURLは以下の手順で作成できます：

#### 方法1: YouTube上で取得

1. YouTube動画を開く
2. 該当箇所まで再生を進める
3. 動画を右クリック → 「現時点の動画のURLをコピー」を選択
4. コピーされたURLを使用

#### 方法2: 手動で作成

1. 配信URLを取得: `https://www.youtube.com/live/{VIDEO_ID}?si={SHARE_ID}`
2. タイムスタンプを秒数に変換:
   - 例: 1:03:13 = (1 × 3600) + (3 × 60) + 13 = 3793秒
3. URLの末尾に`&t={秒数}s`を追加:
   - 例: `https://www.youtube.com/live/rPoEadXC5ck?si=PyjsfpuwHgwH2fjV&t=3793s`

## データ追加時の注意事項

### 1. 文字エンコーディング

- **必須**: UTF-8エンコーディングで保存してください
- BOM（Byte Order Mark）なしを推奨
- Windowsのメモ帳を使用する場合は、「UTF-8」を選択してください

### 2. タブ区切り

- カラム間の区切りは必ずタブ文字（`\t`）を使用してください
- スペースやカンマは使用しないでください
- Excelで編集する場合は、保存時に「テキスト（タブ区切り）」形式を選択してください

### 3. データの整合性

- **LIVE_ID**: M_YT_LIVE_TIMESTAMP.TSVのLIVE_IDは、必ずM_YT_LIVE.TSVに存在するIDを指定してください
- **ID**: 各ファイル内でIDが重複しないように注意してください
- **タイムスタンプ**: 配信の長さを超えるタイムスタンプを指定しないでください

### 4. 特殊文字の扱い

- タブ文字（`\t`）: データ内に含めないでください（カラム区切りと混同されます）
- 改行文字（`\n`、`\r`）: データ内に含めないでください（行区切りと混同されます）
- その他の特殊文字（絵文字、記号など）: 使用可能ですが、UTF-8で正しく保存されることを確認してください

### 5. データの順序

- **M_YT_LIVE.TSV**: 配信日順に並べることを推奨しますが、必須ではありません
- **M_YT_LIVE_TIMESTAMP.TSV**: LIVE_ID順、タイムスタンプ順に並べることを推奨しますが、必須ではありません
- **V_SONG_LIST.TSV**: アーティスト(ソート用)順に並べることを推奨しますが、アプリケーション側で自動ソートされます

### 6. データの検証

データ追加後は、以下の点を確認してください：

1. **ファイルが正しく保存されているか**
   - UTF-8エンコーディングで保存されているか
   - タブ区切りが正しく保持されているか

2. **アプリケーションで正しく表示されるか**
   - `streamlit run Home.py`でアプリケーションを起動
   - 検索機能で新しく追加した楽曲が検索できるか
   - YouTubeリンクが正しく動作するか
   - 楽曲リストページで新しい楽曲が表示されるか

3. **エラーが発生していないか**
   - アプリケーション起動時にエラーメッセージが表示されないか
   - ブラウザのコンソールにエラーが表示されないか

## データバックアップの推奨方法

データの損失を防ぐため、定期的なバックアップを推奨します。

### 1. 手動バックアップ

#### 方法1: フォルダごとコピー

```
1. dataフォルダ全体をコピー
2. バックアップ先に「data_backup_YYYYMMDD」のような名前で保存
3. 定期的（週1回程度）に実施
```

#### 方法2: 個別ファイルのバックアップ

```
1. 各TSVファイルをコピー
2. ファイル名に日付を追加（例: M_YT_LIVE_20250427.TSV）
3. backupフォルダに保存
```

### 2. Gitによるバージョン管理

プロジェクトでGitを使用している場合、データファイルもバージョン管理することを推奨します。

```bash
# データファイルの変更をコミット
git add data/
git commit -m "データ更新: 2025年4月27日の配信を追加"
git push
```

#### 注意事項

- 大きなファイルはGitの管理に適さない場合があります
- プライベートリポジトリを使用してください（公開リポジトリの場合、データの著作権に注意）

### 3. クラウドストレージへのバックアップ

Google Drive、Dropbox、OneDriveなどのクラウドストレージにバックアップすることも有効です。

```
1. dataフォルダをクラウドストレージに同期
2. 自動バックアップ機能を有効化
3. 定期的にバックアップが取られていることを確認
```

### 4. バックアップの復元

データが破損した場合や誤って削除した場合は、バックアップから復元できます。

```
1. バックアップファイルを確認
2. 最新のバックアップをdataフォルダにコピー
3. アプリケーションを再起動
4. データが正しく表示されることを確認
```

## トラブルシューティング

### データが表示されない

**原因1: ファイルが見つからない**
- 解決策: dataフォルダにファイルが存在するか確認してください

**原因2: エンコーディングが正しくない**
- 解決策: UTF-8エンコーディングで保存し直してください

**原因3: タブ区切りが正しくない**
- 解決策: カラム間がタブ文字で区切られているか確認してください

### 文字化けが発生する

**原因: エンコーディングが正しくない**
- 解決策: UTF-8エンコーディングで保存し直してください
- Windowsのメモ帳の場合: 「名前を付けて保存」→「エンコード」で「UTF-8」を選択

### YouTubeリンクが動作しない

**原因1: URLが正しくない**
- 解決策: YouTube配信のURLを正しい形式で記述してください

**原因2: タイムスタンプが正しくない**
- 解決策: タイムスタンプを秒数に正しく変換してください

**原因3: LIVE_IDが存在しない**
- 解決策: M_YT_LIVE.TSVに対応する配信データが存在するか確認してください

### 楽曲が重複して表示される

**原因: V_SONG_LIST.TSVに同じ楽曲が複数回登録されている**
- 解決策: 重複したエントリを削除してください

## データ管理のベストプラクティス

1. **定期的なバックアップ**: 週1回程度、データファイルをバックアップしてください
2. **変更履歴の記録**: データを更新した際は、変更内容をメモしておくことを推奨します
3. **データの検証**: 新しいデータを追加した後は、必ずアプリケーションで動作確認してください
4. **エンコーディングの統一**: 全てのファイルをUTF-8エンコーディングで保存してください
5. **命名規則の統一**: アーティスト名や曲名の表記を統一してください（例: 「feat.」と「ft.」を混在させない）
6. **ドキュメントの更新**: データ構造を変更した場合は、このドキュメントも更新してください

## 参考情報

- [Streamlit公式ドキュメント](https://docs.streamlit.io/)
- [Pandas公式ドキュメント](https://pandas.pydata.org/docs/)
- [YouTube埋め込みガイド](https://support.google.com/youtube/answer/171780)

## 更新履歴

| 日付 | 変更内容 | 担当者 |
|------|---------|--------|
| 2025/11/18 | 初版作成 | - |

---

**注意**: このドキュメントは「しのうたタイム」アプリケーションのデータ管理に関する情報を提供するものです。データの正確性については保証できませんので、ご了承ください。
